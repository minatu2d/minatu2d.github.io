<!DOCTYPE html>
<html lang="en-us">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>[OE] Build một bản Linux cho Raspberry PI B&#43; sử dụng OpenEmbedded</title>
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="#ZgotmplZ">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/html.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/ruby.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/perl.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.58.3" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">[OE] Build một bản Linux cho Raspberry PI B&#43; sử dụng OpenEmbedded</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                                <li><a href="/categories/">Category</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:pvta2pn@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/minatu2d/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://facebook.com/pvta2cvp/"><i class="fa fa-facebook"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>[OE] Build một bản Linux cho Raspberry PI B&#43; sử dụng OpenEmbedded</h2>
        <h5>April 25, 2015</h5>
        
<a href="localhost:1313tags/raspberrypi"><kbd class="item-tag">RaspberryPI</kbd></a>


    </div>

    <div align="start" class="content">

<p>Poky là một hệ distro linux ở dạng tham chiếu của Yocto Project.</p>

<p>OpenEmbedded là một phần trong đó.</p>

<p>Nào thế đủ rồi, ta đi vào phần chính.</p>

<h3 id="1-về-yocto-project-và-ứng-dụng-cho-rasberry-pi">1. Về Yocto project và ứng dụng cho Rasberry PI</h3>

<p>Lần trước, tôi có viết một hứng về việc <a href="http://www.cnx-software.com/2012/07/31/84-mb-minimal-raspbian-armhf-image-for-raspberry-pi/">tạo ra một ảnh cho Raspberry</a> dựa trên Raspbian (chụp lại ảnh của một hệ thống đang chạy). Với kết quả lúc trước, thì vấn đề là nó không thực sự nhỏ hơn, khi giải nén ra nó vẫn chiếm khoảng 414MB.</p>

<p>Nào, ngay hôm nay, tôi sẽ hướng dẫn để tạo một ảnh của hệ thống (Linux distro) sử dụng Yocto Project,</p>

<p>1 platform cho phép bạn build một Embedded Linux Distribution phù hợp chính xác với yêu cầu của dự án.</p>

<p>Một điểm nữa là, quá trình build có thể được <strong>configure với các configure file</strong>. Nó khá năng suất trong việc tạo ra một bản distro chỉ với rất ít thao tác.</p>

<p>Nếu bạn muốn image, bạn có thể download về ngày qua <a href="http://www.cnx-software.com/raspberry-pi/rpi-basic-image-raspberrypi-20130702123605.rootfs.rpi-sdimg.7z">link </a>này.</p>

<p>Sau khi download về rồi thì giải nén nó, ghi vào SD card. Rồi chạy thôi.</p>

<p>Còn nếu bạn muốn customize nó thì tiếp tục đọc.</p>

<p>Tôi đã thử với hướng dẫn từ <a href="http://www.pimpmypi.com/blog/blogPost.php?blogPostID=7" title=" pimpmypi">pimpmypi</a>. Nhưng nó khá cũ, giờ mọi thứ dường như trở nên đơn gian hơn.</p>

<h3 id="2-thực-hiện">2. Thực hiện</h3>

<p>Với môi trường thực hiện là Ubuntu 14.04 LTS.</p>

<h4 id="2-1-lấy-source">2.1 Lấy source</h4>

<p>Đầu tiên chúng ta lấy source của poky và meta layer dành cho Raspberry PI.</p>

<pre><code class="language-bash">mkdir yocto

cd yocto

git clone -b dylan git://git.yoctoproject.org/poky.git

cd poky

git clone -b dylan git://git.yoctoproject.org/meta-raspberrypi
</code></pre>

<h3 id="2-2-thiết-lập-biến-môi-trường">2.2 Thiết lập biến môi trường</h3>

<p>Chạy lệnh sau để setup một số biến môi trường</p>

<pre><code class="language-bash">
. oe-init-build-env build

</code></pre>

<p>Nhất định phải có dấu cách sau dấu &ldquo;.&rdquo; . (Dấu này đại diện cho lệnh <code>source</code>)</p>

<p>Sau khi chạy xong lệnh trên và succecced.</p>

<p>Con trỏ lệnh sẽ tự động chuyển về thư mục build.</p>

<h3 id="2-3-build">2.3 Build</h3>

<p>Chúng sẽ edit 1 file cấu hình để giúp bitbake sử dụng CPU của PC chúng ta build tốt hơn.</p>

<p>Giúp tiết kiệm thời gian build.</p>

<pre><code class="language-bash">
Edit conf/local.conf

BB_NUMBER_THREADS = &quot;9&quot;

PARALLEL_MAKE = &quot;-j 9&quot;

MACHINE ?= &quot;raspberrypi&quot;

GPU_MEM = &quot;16&quot;
</code></pre>

<p>Trường nào không có thì bỏ qua, kết quả cuối cùng không thay đổi tuy nhiên, nếu cấu hình chính xác</p>

<p>với thông tin của máy sẽ giúp quá trình build nhanh hơn.</p>

<p>Cuối cùng, để OE build một image cho Raspberry PI, ta cần thêm lớp của RPI vào danh sách các lớp</p>

<p>mà OE có thể biết.</p>

<pre><code class="language-bash">
Edit conf/bblayers

BBLAYERS ?= &quot; \

poky/meta \

poky/meta-yocto \

poky/meta-yocto-bsp \

poky/meta-raspberrypi \

&quot;
</code></pre>

<p>Giờ là lệnh build, có 2 option cho file image. Đó là <strong>rpi-basic-image</strong> và <strong>rpi-hwup-image</strong>.</p>

<p>Cả 2 đều là minimal image. Nhưng <strong>rpi-basic-image</strong> có sẵn ssh-server-dropbear và splash</p>

<p>(cho splash screen).</p>

<p>Chúng ta sẽ build <strong>rpi-basic-image</strong></p>

<p>Lệnh build như sau</p>

<pre><code class="language-bash">
`bitbake rpi-basic-image`

</code></pre>

<p>Quá trình build này phụ thuộc vào perform của máy và tốc độ mạng.</p>

<p>Có thể mất cả tiếng đồng hồ.</p>

<h3 id="2-4-kết-quả">2.4 Kết quả</h3>

<p>Khi quá trình build này hoàn thành, bạn sẽ thấy file ảnh nằm ở đây</p>

<p><code>tmp/deploy/images/rpi-basic-image-raspberrypi.rpi-sdimg</code></p>

<p>Ghi file đó ra SD Card là bạn đã có thể boot ngay vào PI được rồi.</p>

<p>User là root và không cần pass.</p>

<h3 id="2-5-đặc-điểm-của-bản-build">2.5 Đặc điểm của bản build</h3>

<p>Bản linux này bao gồm những đặc điểm sau</p>

<ul>
<li>shell chạy là : busybox, đương nhiên là thư viện là uglibc rồi.</li>
</ul>

<p><del>+ Không tích hợp driver cho wifi dongle.</del></p>

<ul>
<li>Chưa thấy code car wlan0.</li>
<li>Có sắn driver cho Ethernet</li>
</ul>

<p>Tình trạng sau khi khởi động của máy như thế này</p>

<p><img src="{{.Site.BaseURL}}/assets/dsc_0084.jpg?w=300" alt="Featured image" /></p>

<p>Trong hình trên, dù đã kết nối wireless dongle với PI qua USB rồi.</p>

<p>Kiểm tra lại log hệ thống để xem, PI đã nhận dạng được thiết bị này chưa.</p>

<p>Log như hình sau, ở đây t sử dụng lệnh</p>

<pre><code class="language-bash">
`tail -f /var/log/messages `

</code></pre>

<p>Ta sẽ thấy log dưới đây khi cắm wire dongle vào PI.</p>

<p><img src="{{ site.baseurl }}/assets/dsc_0086.jpg?w=300" alt="Featured image" /></p>

<p>Từ màn hình log ta thấy, thiết bị dường như đã được nhận dạng thành công.</p>

<p>Hiện tại có thể đã lỗi tại dòng</p>

<p>phy3: Failed to initialize wep : -2</p>

<p>Mình có 2 suy đoán ở đây</p>

<ul>
<li>Có thể phần wireless thiếu file cấu hình nên xảy ra tình trạng này.</li>
<li>Có thể vẫn do lỗi driver, thiếu cái gì đó vì nếu chỉ khởi động bị failure thì phần hàm ifconfig phải list ra được chứ nhi.</li>
</ul>

<p>Giờ sẽ thử làm theo hướng dẫn này, đưa file cấu hình wifi vào PI</p>

<p><a href="http://www.jann.cc/2012/08/08/building_freescale_s_community_yocto_bsp_for_the_olinuxino.html#extending-the-wifi-support">http://www.jann.cc/2012/08/08/building_freescale_s_community_yocto_bsp_for_the_olinuxino.html#extending-the-wifi-support</a></p>

<p>Trong thư mục build của yocto, add thêm dòng này vào <strong>conf/local.conf</strong><br />
IMAGE_INSTALL_append = &ldquo; wpa-supplicant wireless-tools dhcp-client linux-firmware&rdquo;</p>
</div>

    
    
    
        <h4 class="page-header">Related</h4>
         <div class="item">

    
    
    

    
    

    <h4><a href="/post/2016-07-29-tao-nas-server-tren-pi-bang-yocto-project/">Tạo một bản build Linux cho Raspberry PI bằng Yocto Project</a></h4>
    <h5>July 29, 2016</h5>
    
<a href="localhost:1313tags/kernel"><kbd class="item-tag">Kernel</kbd></a>

<a href="localhost:1313tags/linuximage"><kbd class="item-tag">LinuxImage</kbd></a>

<a href="localhost:1313tags/raspberrypi"><kbd class="item-tag">RaspberryPI</kbd></a>



</div>
 
    

    
    
        <h4 class="page-header">Comments</h4>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "username" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</main>

        <footer>
            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

