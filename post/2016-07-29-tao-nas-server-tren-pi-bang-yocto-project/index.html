<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Tạo một bản build Linux cho Raspberry PI bằng Yocto Project - Lazytrick - Limited size memory of mind</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick - Limited size memory of mind" rel="home">
				<div class="logo__title">Lazytrick - Limited size memory of mind</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Viết những gì?</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">Ai viết?</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Tạo một bản build Linux cho Raspberry PI bằng Yocto Project</h1>
			
			


<br>
<i data-feather="calendar">
  <u>Published: <b><time datetime="2016-07-29 00:00:00 &#43;0700">Fri, 29 Jul 2016 08:06:07</time></b> | Last modified:<b><time datetime="2016-07-29 00:00:00 &#43;0700">Fri, 29 Jul 2016 08:06:07</time></b></u>
  </i> 
		</header><div class="content post__content clearfix">
			

<p>Ban đầu, dự định sẽ tạo một NAS server theo link tham khảo bên dưới.<br />
Nhưng thấy ta nên tách riêng phần tạo bản phân phối Linux thành 1 bài riêng, rồi viết các nội dung liên quan đến customize thành các bài khác sẽ dễ hiểu hơn.<br />
Hơn nữa, phần tạo bản build basic sẽ cần được thảo luận kĩ hơn do có thể phát sinh nhiều vấn đề. Mà nếu không giải quyết được các vấn đề đó thì nội dung các bài khác sẽ không thể thực hiện được.<br />
Do vậy, bài này sẽ tập trung vào tạo bản basic <strong>rpi-basic-image</strong> thôi.</p>

<p>Link tham khảo:<br />
<a href="http://mickey-happygolucky.hatenablog.com/entry/2015/02/14/002035">http://mickey-happygolucky.hatenablog.com/entry/2015/02/14/002035</a></p>

<h2 id="1-tạo-một-bản-build-cho-raspberry-pi-từ-ubuntu-bằng-yocto-project">1. Tạo một bản build cho Raspberry PI từ Ubuntu bằng Yocto Project</h2>

<p>Mục đích của bước này là tạo ra được một ảnh đĩa (file .img giống như Raspabian cung cấp cho người dùng tại <a href="https://www.raspberrypi.org/downloads/raspbian/">đây</a>, sau khi đã giải nén). Sử dụng kết quả của <a href="https://www.yoctoproject.org/">Yocto Project</a> - một khung (framework) cho phép tạo ra một bản Linux có thể tùy biến được. Yocto Project cung cấp một bản phân phối Linux (gọi là Poky), người dùng có thể build cho rất nhiều target (gồm mainboard, chíp,etc) khác nhau.</p>

<p>Việc build một bản Linux cho RPI trong trường hợp này là quá trình build Poky cho board Raspberry PI, chip là ARM (không nhớ phiên bản lắm).</p>

<p>Nhưng thông tin có vẻ nghe khó hiểu và phức tạp, nhưng ta chỉ hiểu rằng ta Raspberry là một trong nhiều target mà Yocto Project hỗ trợ build OS cho. Vậy thôi, bắt đầu nào. Nó đơn giản hơn chúng ta nghĩ rất nhiều, chỉ tốn thời gian và khoảng trống ổ đĩa thôi.</p>

<p>À, cần ít nhất khoảng 30GB trước khi thực hiện các bước này, một mạng có tốc độ tốt sẽ giúp giảm thời gian hoàn thành các bước bên dưới còn nửa ngày chẳng hạn :)))</p>

<ul>
<li><p>Trước khi bắt đầu, ta nên cài các gói cần thiết như dưới để đỡ phải cài lúc gặp lỗi:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib <span style="color:#cd5555">\ </span> 
build-essential chrpath socat libsdl1.2-dev xterm  </code></pre></div></li>

<li><p>Tạo thư mục cần build, hiện tại <strong>krogoth</strong> đang là bản mới nhất:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$mkdir</span> raspberrpi_krogoth  </code></pre></div></li>

<li><p>Tải các Poky, như cách mọi người vẫn làm với <strong>git</strong> :</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$cd</span> raspberrpi_krogoth  
$  
<span style="color:#00688b">$git</span> clone -b krogoth git://git.yoctoproject.org/poky.git  </code></pre></div></li>

<li><p>Như ta đã nói ở phần đầu, Poky là một bản phân phối Linux của Yocto Project, mặc định của nó không hỗ trợ RPI (chỉ có Texas Instruments Beaglebone - beaglebone và Freescale MPC8315E-RDB - mpc8315e-rdb mà thôi, xem thêm tại <a href="http://git.yoctoproject.org/cgit/cgit.cgi/poky/tree/README.hardware?h=krogoth">đây</a>). Vì thế, ta phải tải phần hỗ trợ liên quan đến bo mạch (BSP) của RPI<br />
<strong>jethro</strong> là bản mới nhất</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$cd</span> poky  
$  
<span style="color:#00688b">$git</span> clone -b jethro git://git.yoctoproject.org/meta-raspberrypi  </code></pre></div></li>
</ul>

<p>Đến đây, ta đã được 1 nửa về mặt thao tác phải làm, nhưng chỉ mới <sup>1</sup>&frasl;<sub>10</sub> về mặt thời gian phải đợi. Xin hãy từ từ :))</p>

<p>Tiếp theo, ta bắt đầu vào build.<br />
- Thiết lập các biến môi trường<br />
Do poky đã cung cấp sẵn script thiết lập các biến này rồi.<br />
Ta chỉ cần chạy.</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$source</span> poky/oe-init-build-env build  </code></pre></div>
<p>(có thể không cần <strong>buid</strong> ở cuối)<br />
Sau khi chạy xong lệnh trên, đường dẫn sẽ tự động chuyển về thư mục build của Yocto. Ta bắt đầu làm mọi thứ từ đây.<br />
Nó có dạng kiểu như thế này:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">oedev@OEDEV-Ubuntu:~/raspberrypi_krogoth/build$  </code></pre></div>
<ul>
<li>Poky chia các gói phần mềm thành các layer (lớp), gói hỗ trợ RPI cũng vậy, vì không được hỗ trợ mặc định nên ta phải thêm vào bằng cách:</li>
</ul>

<p>Mở file <strong>build/conf/bblayers.conf</strong> bằng <em>nano</em>, <em>vi</em> hoặc bất cứ editor nào.<br />
Rồi thêm đường dẫn đến gói hỗ trợ bo mạch RPI.<br />
Sau khi sửa, nó sẽ có nội dung kiểu như sau:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">oedev@OEDEV-Ubuntu:~/raspberrypi_krogoth/build$ cat conf/bblayers.conf

<span style="color:#228b22"># POKY_BBLAYERS_CONF_VERSION is increased each time build/conf/bblayers.conf</span>  
<span style="color:#228b22"># changes incompatibly</span>  
<span style="color:#00688b">POKY_BBLAYERS_CONF_VERSION</span> = &amp;amp;quot;<span style="color:#b452cd">2</span>&amp;amp;quot;

<span style="color:#00688b">BBPATH</span> = &amp;amp;quot;<span style="color:#cd5555">${</span><span style="color:#00688b">TOPDIR</span><span style="color:#cd5555">}</span>&amp;amp;quot;  
BBFILES ?= &amp;amp;quot;&amp;amp;quot;

BBLAYERS ?= &amp;amp;quot; <span style="color:#cd5555">\ </span> 
/home/oedev/raspberrypi_krogoth/poky/meta <span style="color:#cd5555">\ </span> 
/home/oedev/raspberrypi_krogoth/poky/meta-poky <span style="color:#cd5555">\ </span> 
/home/oedev/raspberrypi_krogoth/poky/meta-yocto-bsp <span style="color:#cd5555">\ </span> 
/home/oedev/raspberrypi_krogoth/poky/meta-raspberrypi <span style="color:#cd5555">\ </span><span style="color:#228b22"># mới thêm vào</span>  
&amp;amp;quot;  </code></pre></div>
<ul>
<li>Tiếp theo, ta phải thay đổi Target Machine,</li>
</ul>

<p>Bản phân phối Poky của Yocto Project hỗ trợ rất nhiều Target Machine, trong đó có những Board mặc định của TI, Freescale hoặc chương trình mô phỏng phần cứng Qemu.</p>

<p>Raspberry PI không được hỗ trợ mặc định nên ta phải thêm nó vào.</p>

<p>Mở file <strong>build/conf/local.conf </strong>và sửa như sau:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">....  
<span style="color:#228b22">#MACHINE ?= &#34;qemuarm64&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;qemumips&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;qemumips64&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;qemuppc&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;qemux86&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;qemux86-64&#34;</span>  
#  
<span style="color:#228b22"># There are also the following hardware board target machines included for</span>  
<span style="color:#228b22"># demonstration purposes:</span>  
#  
<span style="color:#228b22">#MACHINE ?= &#34;beaglebone&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;genericx86&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;genericx86-64&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;mpc8315e-rdb&#34;</span>  
<span style="color:#228b22">#MACHINE ?= &#34;edgerouter&#34;</span>  
#  
<span style="color:#228b22"># This sets the default machine to be qemux86 if no other machine is selected:</span>  
MACHINE ??= <span style="color:#cd5555">&#34;qemux86&#34;</span>

<span style="color:#228b22"># Thêm vào cho RaspberryPI</span>  
MACHINE ?= <span style="color:#cd5555">&#34;raspberrypi&#34;</span>  
....  </code></pre></div>
<ul>
<li><p>Giờ bắt đầu build và bỏ máy, ở phần chạy lệnh <strong>source</strong> phía trên, ta có thể thấy một đoạn được hiện ra với hướng dẫn kiểu <strong>bitbake XXX</strong>.<br />
Ta cũng làm tương tự như vậy</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$bitbake</span> rpi-basic-image  </code></pre></div></li>
</ul>

<p>Bước này sẽ thực hiện việc tải các source cần thiết, thực hiện các sửa, thực hiện tạo compiler, build source, rồi tạo image.<br />
<strong>rpi-basic-image</strong> : là 1 một images mà framework có thể tạo, ta có thể xem danh sách các images khác bằng đường dẫn bên dưới đây:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">oedev@OEDEV-Ubuntu:~/raspberrypi_krogoth/poky/meta-raspberrypi$ ls recipes-core/images/  
rpi-basic-image.bb rpi-hwup-image.bb rpi-test-image.bb  </code></pre></div>
<p>Trong quá trình thực hiện, có thể gặp phải lỗi kiểu như sau:</p>

<p>Error.01 : Việc tải bị timeout: chỉ có cách thực hiện lại một vài lần<br />
Tức là chạy lại câu lệnh <strong>bitbake rpi-basic-image</strong> ở phía trên.<br />
Error.02 : Không tìm thấy file <strong>mkknlimg</strong>:<br />
Lỗi sẽ hiện ra kiểu như thế này:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">DEBUG: Executing shell <span style="color:#8b008b;font-weight:bold">function</span> do_rpiboot_mkimage  
/build/tmp/sysroots/x86_64-linux/usr/lib/rpi-mkimage/mkknlimg: not found  
WARNING: <span style="color:#658b00">exit</span> code <span style="color:#b452cd">127</span> from a shell command.  </code></pre></div>
<p>Đây là lỗi đường dẫn, hãy sửa bằng cách:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#228b22">#Tìm kiếm mkknlimg xem có ở đâu đó không.</span>  
$ locate mkknlimg  </code></pre></div>
<p>Sẽ có kết quả dạng:<br />
_&hellip;/tmp/sysroots/x86<em>64-linux/usr/libexec/mkknlimg</em><br />
Ta đi sửa cho đúng là ok.<br />
Mở file <em>poky/meta-raspberrypi/recipes-kernel/linux/linux-raspberrypi.inc</em><br />
Tìm đến hàm _do_rpiboot<em>mkimage()</em> sửa thành như sau:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#228b22">#Comment dòng cũ này: ${STAGING_DIR_NATIVE}/usr/lib/rpi-mkimage/mkknlimg ...  </span>
<span style="color:#a61717;background-color:#e3d2d2">$</span>{STAGING_DIR_NATIVE}/usr/libexec/mkknlimg ...  </code></pre></div>
<p>Error.03 : Việc tải <strong>bcm2835-bootfiles</strong> dường như bị đứng lại, thực ra không phải vậy, nó nặng đến 3GB, nếu đường truyền chậm thì rất có thể phải đợi rất lâu, ta có cả giác nó không hề làm việc. Nhưng hãy cố gắng đợi nha. :))</p>

<p>Error.04 : Lỗi khi kiểm tra check sum của image được build ra, lỗi này được sửa bằng cách thêm 1 dòng vào file dưới đây:</p>

<p>_poky/meta-raspberrypi/classes/sdcard<em>image-rpi.bbclass</em></p>

<p>Nội dung đoạn thêm sẽ như thế này:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">IMAGEDATESTAMP = <span style="color:#cd5555">&#34;${@time.strftime(&#39;%Y.%m.</span><span style="color:#cd5555">%d</span><span style="color:#cd5555">&#39;,time.gmtime())}&#34;</span>  
<span style="color:#228b22">#Nội dung thêm vào:  </span>
IMAGE_CMD_rpi-sdimg[vardepsexclude] = <span style="color:#cd5555">&#34;IMAGEDATESTAMP&#34;</span>  </code></pre></div>
<p>Sau khi thực hiện xong bước build images, ta sẽ thu được images trong thư mục<br />
<strong>build/tmp/deploy/images/raspberrypi</strong> với tên <strong>rpi-basic-image-raspberrypi.rpi-sdimg</strong>.</p>

<p>Ta có thể ghi vào thẻ nhớ để để boot RPI bình thường</p>

<p>Việc ghi ra thẻ nhớ thì làm theo hướng dẫn dành cho Raspbian ở link <a href="https://www.raspberrypi.org/documentation/installation/installing-images/linux.md">này</a>.</p>

<p>Update: 2017/02/14: Cám ơn bạn HocARM review và phát phát hiện ra chỗ thiếu phần configure Target Machine.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/kernel/" rel="tag">Kernel</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/linuximage/" rel="tag">LinuxImage</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/raspberrypi/" rel="tag">RaspberryPI</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-blog-lazytrick-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick - Limited size memory of mind.
			<span class="footer__copyright-credits">Convert nội dung Markdown sang HTML bằng <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and sử dụng theme <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>