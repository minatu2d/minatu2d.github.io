<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Một số thứ khi sử dụng command, viết script trong bash - Lazytrick - Limited size memory of mind</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53476519-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick - Limited size memory of mind" rel="home">
				<div class="logo__title">Lazytrick - Limited size memory of mind</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Viết những gì?</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">Ai viết?</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Một số thứ khi sử dụng command, viết script trong bash</h1>
			
			


<br>
<i data-feather="calendar">
  <u>Published: <b><time datetime="2017-11-03 00:00:00 &#43;0700">Fri, 03 Nov 2017 06:31:11</time></b> | Last modified:<b><time datetime="2017-11-03 00:00:00 &#43;0700">Fri, 03 Nov 2017 06:31:11</time></b></u>
  </i> 
		</header><div class="content post__content clearfix">
			

<p>Bài này xin được trích rút một số thứ hữu ích từ bài viết rất hay tên <a href="https://github.com/jlevy/the-art-of-command-line">The art of command line</a> và mình cũng đã dịch thử (chưa được review) ở<br />
<a href="https://github.com/minatu2d/the-art-of-command-line/blob/master/README-vi.md">Nghệ thuật sử dụng dòng lệnh</a></p>

<h2 id="1-hạn-chế-gõ-lại-câu-lệnh-cho-dù-là-rất-ngắn">1. Hạn chế gõ lại câu lệnh cho dù là rất ngắn</h2>

<p>Hãy sử dụng chức năng tìm đoạn đang gõ trong history để làm giảm công gõ lại<br />
Hai chức năng tìm xuôi và tìm ngược được bash cung cấp rồi.<br />
Chỉ việc gán phím tắt là sử dụng được thôi.<br />
Cách làm được miêu tả trong bài <a href="https://lazytrick.wordpress.com/2017/04/02/phim-tat-cho-bash/">Phím tắt cho bash</a>.<br />
Đơn giản là thêm đoạn sau vào <code>~/.bashrc</code></p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#228b22"># Add some shortcut key for quickly search history commands</span>  
<span style="color:#228b22"># e -&gt; Alt key</span>  
<span style="color:#228b22"># C -&gt; Ctrl key</span>  
<span style="color:#658b00">bind</span> <span style="color:#cd5555">&#39;&#34;\ep&#34;: history-search-backward&#39;</span>  
<span style="color:#228b22"># Use Alt + p</span>  
<span style="color:#658b00">bind</span> <span style="color:#cd5555">&#39;&#34;\en&#34;: history-search-forward&#39;</span>  
<span style="color:#228b22"># Use Alt + n</span>  </code></pre></div>
<h2 id="2-sử-dụng-xargs-để-biến-mọi-thứ-thành-tham-số">2. Sử dụng <strong>xargs</strong> để biến mọi thứ thành tham số</h2>

<p><code>args</code> để biến mọi thứ thành tham số cho lệnh khác.<br />
Ví dụ muốn thực hiện tạo bản backup (thêm đuôi _<em>backup</em> chẳng hạn) cho các file <code>.txt</code> trong thư mục chẳng hạn.</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$ls</span> *.txt|xargs -I hello cp hello hello_backup  </code></pre></div>
<p>Khi muốn tạo một lệnh phức tạp sử dụng tham số được lấy từ <code>xargs</code>, hoặc không chắc chắn về câu lệnh thì hãy in toàn bộ đoạn câu lệnh ra bằng cách đặt trong lệnh <code>echo</code><br />
Ví dụ với đoạn backup ở trên:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$ls</span> *.txt|xargs -I hello <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#39;cp hello hello_backup&#39;</span>  </code></pre></div>
<p>Ta sẽ có danh sách các câu lệnh định viết được hiển thị ra màn hình.<br />
Vì thế có thể dễ dàng kiểm tra xem câu lệnh đã viết đúng chưa, hoặc thử thực hiện một câu mẫu xem kết quả như mong muốn không rồi mới thực hiện thực sự.<br />
Với mình, mình thường viết như này:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$ls</span> *.txt|xargs -I hello <span style="color:#658b00">echo</span> <span style="color:#cd5555">&#39;cp hello hello_backup &amp;&amp; echo &#34;Finished hello&#34;&#39;</span> &gt; tmp_script.sh  </code></pre></div>
<p>Sau đó mình sẽ có scipt tên là <code>tmp_script</code> chứa những câu lệnh định chạy.<br />
Giờ lấy một câu trong đó chạy thử, nếu ok thì chạy script đó là xong.</p>

<h2 id="3-hãy-thiết-lập-header-cẩn-thận-cho-bash-script">3. Hãy thiết lập header cẩn thận cho bash script</h2>

<p>Ta biết rằng, đã là script thì các lệnh được chạy lần lượt đến khi phải dừng thì thôi.<br />
Nếu viết những script mà thực hiện các thao tác quan trọng như move, xóa, sửa, hay nói chung là có thể làm mất dữ liệu quan trọng mà ta dính phải những lỗi cơ bản liên quan đến tên file, tham số thì sẽ gây thiệt hại và một sự mất công không hề nhỏ.<br />
Để tránh những lỗi đó trong bài tham khảo ở trên có đưa ra một cấu hình khi thực hiện script.</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#658b00">set</span> -euo pipefail  
<span style="color:#658b00">trap</span> <span style="color:#cd5555">&#34;echo &#39;Trapped: Script failed: see failed command above&#39;&#34;</span> ERR  </code></pre></div>
<p>Theo kinh nghiệm của mình, <strong>đoạn trên nên được đặt ở phần đầu mẫu khi viết bash script.</strong><br />
Giải thích đoạn trên:<br />
<code>set -e</code> : dừng khi bất cứ câu lệnh nào trong script trả về lỗi khác 0 (lỗi thường được quy định là nonzero)<br />
<code>set -u</code> : dừng lại khi gặp một biến được sử mà chưa hề được set trước đó<br />
<code>set -o pipefail</code> : dừng lại khi gặp lỗi liên quan đến pipe<br />
<code>trap</code> : chạy đoạn lệnh khi script gặp lỗi, đoạn trên là dừng và thông báo là có lỗi đó.<br />
Ngoài ra, có thể thêm <code>set -x</code> nếu muốn debug script, tức là mỗi câu lệnh được hiển thị ra màn hình ngay trước khi nó được thực hiện (bao gồm các giá trị biến, tham số truyền cho nó)</p>

<h2 id="4-biết-về-giới-hạn-128k">4. Biết về giới hạn <strong>128K</strong></h2>

<p>Chính là độ dài tối đa của một câu lệnh.<br />
Có thể bạn sẽ tự hỏi, mấy ai viết nổi câu lệnh dài từng đó.<br />
Nếu viết bằng tay, thì đúng là như thế.<br />
Nhưng ở đây nói đến độ dài câu lệnh sau khi được phân giải hết các giá trị mở rộng như <code>*</code>, <code>..</code>, <code>?</code>, etc.<br />
Chắc chắn bạn quen với câu lệnh dạng:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$ls</span> *.html  </code></pre></div>
<p>Độ dài khi ta gõ ở đây là 6 + 1 (kí trự cuối chuỗi) = 7, nhưng độ dài thực sự khi được thực hiện thì không hẳn như thế vì bash (các interpreter cũng thế) sẽ thực hiện thao tác mở rộng để thay thế kí tự <code>*</code> ở trên.<br />
Câu lệnh được chạy sẽ có dạng <code>ls file1.html file2.html ...</code><br />
Nếu trong thư mục bạn thực hiện lệnh trên có 20K files, mà mỗi file dài chừng 7 kí tự, tức là ngoài đuôi html nó chỉ cần có thêm 3 kí tự nữa thôi thì, đã mất 140K kí tự để đặt chúng cạnh nhau rồi.<br />
Khi đó sẽ có lỗi <code>Argument list too long</code> xảy ra.<br />
Khi thực hiện với lượng file lớn, tốt nhất không nên dùng những kí tự mở kiểu này khi duyệt file.<br />
Hãy sử dụng câu lệnh <code>find</code> để thay thế vì nó thích hợp hơn.</p>

<h2 id="5-xử-lý-với-các-tên-file-bắt-đầu-bằng-kí-tự-minus">5. Xử lý với các tên file bắt đầu bằng kí tự <strong>-</strong> (minus)</h2>

<p>Giả sử khi truyền một file vào câu lệnh, mà tên file lại bắt đầu bằng <strong>-</strong> thì có thể gây lỗi.<br />
Đó là vì bash bị hiểu kí tự <strong>-</strong> là bắt đầu của options.<br />
Ví dụ bạn không thể mở file có tên <code>-abc.txt</code> bằng câu lệnh sau được:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$vi</span> -abc.txt  </code></pre></div>
<p>Nó sẽ hiện lỗi <code>Unknown option argument: &quot;-abc.txt&quot;</code><br />
Để giải quyết cái này, ta chỉ cần thêm đường dẫn cho tên file là được.<br />
Bất cứ đường dẫn nào đều ok.<br />
Ví dụ, câu lệnh dưới đây sẽ ok.</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00688b">$vi</span> ./-abc.txt  </code></pre></div>
<p>Những tên file có kí tự ** -** (trước - là space) cũng vậy. Vì thế, trong trường hợp truyền một biến chứa tên file cho một câu lệnh nên đặt bên trong một cặp nháy kép.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/bash/" rel="tag">Bash</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/script/" rel="tag">script</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-blog-lazytrick-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick - Limited size memory of mind.
			<span class="footer__copyright-credits">Convert nội dung Markdown sang HTML bằng <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and sử dụng theme <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>