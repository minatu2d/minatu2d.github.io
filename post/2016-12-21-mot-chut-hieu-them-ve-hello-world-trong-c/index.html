<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Một chút hiểu thêm về &#34;Hello World&#34; trong C. - Lazytrick</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick" rel="home">
				<div class="logo__title">Lazytrick</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Posts</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">About</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Một chút hiểu thêm về &#34;Hello World&#34; trong C.</h1>
			
		</header><div class="content post__content clearfix">
			

<p>Gần đây, gặp một số vấn đề về Loader-Linker giữa môi trường build và môi trường chạy trong Cross-Compiling.</p>

<p>Có thể bất kì chương nào trong Linux cũng vậy. Nhưng chỉ xét một chường trình được build bằng C thì<br />
một chương trình sẽ được chạy 2 cách dưới đây</p>

<h3 id="1-chương-trình-hoàn-toàn-là-tĩnh">1. Chương trình hoàn toàn là tĩnh</h3>

<ul>
<li>Không có symbol nào cần phải được (resolved) trước khi chạy.</li>
<li>Không yêu cầu bất cứ một thư viện run-time nào.</li>
<li>Kernel cứ thế load vào, rồi nhảy đến vị trí của Program Entry là chạy.</li>
<li>Có kích thước lớn</li>

<li><p>Để build được nó thì các thư viện phụ thuộc khi build cũng phải có phiên bản static.<br />
Lấy ví dụ <strong>HelloWorld</strong></p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#1e889b">#include</span>  
<span style="color:#1e889b">int main(int argc, char *args[])  </span><span style="color:#1e889b">
</span><span style="color:#1e889b"></span>{  
printf(<span style="color:#cd5555">&#34;Hello, Ajinomoto </span><span style="color:#cd5555">\\</span><span style="color:#cd5555">n&#34;</span>);  
<span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#b452cd">0</span>;  
}  </code></pre></div></li>
</ul>

<p>Khi build tĩnh bằng (hầu như phải có <strong>-static</strong>)</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -o helloworld_static helloworld.c -static  </code></pre></div>
<p>Kích thước file chạy sẽ như sau:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -liah helloworld_static  
<span style="color:#b452cd">2910638</span> -rwxrwxr-x <span style="color:#b452cd">1</span> duser duser 717K Dec <span style="color:#b452cd">9</span> <span style="color:#b452cd">13</span>:37 helloworld_static  </code></pre></div>
<p><strong>717KB</strong> cho HelloWorld trên Ubuntu 14.04</p>

<p>Kiểm tra bằng <strong>objdump</strong>:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ objdump -p helloworld_static

helloworld_static: file format elf32-i386

Program Header:  
LOAD off 0x00000000 vaddr 0x08048000 paddr 0x08048000 align <span style="color:#b452cd">2</span>**12  
filesz 0x000a0c77 memsz 0x000a0c77 flags r-x  
LOAD off 0x000a0f40 vaddr 0x080e9f40 paddr 0x080e9f40 align <span style="color:#b452cd">2</span>**12  
filesz 0x00001040 memsz 0x000023c4 flags rw-  
NOTE off 0x000000f4 vaddr 0x080480f4 paddr 0x080480f4 align <span style="color:#b452cd">2</span>**2  
filesz 0x00000044 memsz 0x00000044 flags r--  
TLS off 0x000a0f40 vaddr 0x080e9f40 paddr 0x080e9f40 align <span style="color:#b452cd">2</span>**2  
filesz 0x00000010 memsz 0x00000028 flags r--  
STACK off 0x00000000 vaddr 0x00000000 paddr 0x00000000 align <span style="color:#b452cd">2</span>**4  
filesz 0x00000000 memsz 0x00000000 flags rw-  
RELRO off 0x000a0f40 vaddr 0x080e9f40 paddr 0x080e9f40 align <span style="color:#b452cd">2</span>**0  
filesz 0x000000c0 memsz 0x000000c0 flags r--  </code></pre></div>
<p>Nhìn có vẻ khó hiểu, như chỉ để ý thấy chỉ có phần <strong>Program Header</strong> mà không còn phần nào khác.</p>

<h3 id="2-chương-trình-là-động">2. Chương trình là động</h3>

<ul>
<li>Chứa symbol cần được phân giải trước khi chạy.</li>
<li>Hầu như các command trên Linux đều là dạng này.</li>
<li>Loader-Linker (có đường dẫn tuyệt đối) được ghi bên trong file chạy<br />
tức là nếu yêu cầu loader-linker /lib/ld-linux.so.2 mà môi trường chạy không có thì sẽ có lỗi rất lạ kiểu Không tìm thấy file, hoặc định dạng lỗi, etc.</li>
<li>Tên của thư viện phụ thuộc (không có đường dẫn) được ghi bên trong file chạy.</li>
<li>Kích thước file chạy nhỏ.</li>
</ul>

<p>Tiếp tục thử với <strong>Hello World</strong></p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc -o helloworld helloworld.c  </code></pre></div>
<p>Kiểm tra kích thước file chạy:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -liah helloworld_dynamic  
<span style="color:#b452cd">2910636</span> -rwxrwxr-x <span style="color:#b452cd">1</span> duser duser <span style="color:#b452cd">7</span>.2K Dec <span style="color:#b452cd">9</span> <span style="color:#b452cd">13</span>:37 helloworld_dynamic  </code></pre></div>
<p><strong>7.2K</strong> cho <strong>HelloWorld</strong></p>

<p>Kiểm tra bằng <strong>objdump</strong>:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ objdump -p helloworld_dynamic

helloworld_dynamic: file format elf32-i386

Program Header:  
PHDR off 0x00000034 vaddr 0x08048034 paddr 0x08048034 align <span style="color:#b452cd">2</span>**2  
filesz 0x00000120 memsz 0x00000120 flags r-x  
INTERP off 0x00000154 vaddr 0x08048154 paddr 0x08048154 align <span style="color:#b452cd">2</span>**0  
filesz 0x00000013 memsz 0x00000013 flags r--  
LOAD off 0x00000000 vaddr 0x08048000 paddr 0x08048000 align <span style="color:#b452cd">2</span>**12  
filesz 0x000005c0 memsz 0x000005c0 flags r-x  
LOAD off 0x00000f08 vaddr 0x08049f08 paddr 0x08049f08 align <span style="color:#b452cd">2</span>**12  
filesz 0x00000118 memsz 0x0000011c flags rw-  
DYNAMIC off 0x00000f14 vaddr 0x08049f14 paddr 0x08049f14 align <span style="color:#b452cd">2</span>**2  
filesz 0x000000e8 memsz 0x000000e8 flags rw-  
NOTE off 0x00000168 vaddr 0x08048168 paddr 0x08048168 align <span style="color:#b452cd">2</span>**2  
filesz 0x00000044 memsz 0x00000044 flags r--  
EH_FRAME off 0x000004e4 vaddr 0x080484e4 paddr 0x080484e4 align <span style="color:#b452cd">2</span>**2  
filesz 0x0000002c memsz 0x0000002c flags r--  
STACK off 0x00000000 vaddr 0x00000000 paddr 0x00000000 align <span style="color:#b452cd">2</span>**4  
filesz 0x00000000 memsz 0x00000000 flags rw-  
RELRO off 0x00000f08 vaddr 0x08049f08 paddr 0x08049f08 align <span style="color:#b452cd">2</span>**0  
filesz 0x000000f8 memsz 0x000000f8 flags r--

Dynamic Section:  
NEEDED libc.so.6  
INIT 0x080482b0  
FINI 0x080484b4  
INIT_ARRAY 0x08049f08  
INIT_ARRAYSZ 0x00000004  
FINI_ARRAY 0x08049f0c  
FINI_ARRAYSZ 0x00000004  
GNU_HASH 0x080481ac  
STRTAB 0x0804821c  
SYMTAB 0x080481cc  
STRSZ 0x0000004a  
SYMENT 0x00000010  
DEBUG 0x00000000  
PLTGOT 0x0804a000  
PLTRELSZ 0x00000018  
PLTREL 0x00000011  
JMPREL 0x08048298  
REL 0x08048290  
RELSZ 0x00000008  
RELENT 0x00000008  
VERNEED 0x08048270  
VERNEEDNUM 0x00000001  
VERSYM 0x08048266

Version References:  
required from libc.so.6:  
0x0d696910 0x00 <span style="color:#b452cd">02</span> GLIBC_2.0  </code></pre></div>
<h3 id="3-hiển-thị-thông-về-loader-linker">3. Hiển thị thông về loader-linker</h3>

<p>Khi chương trình động được chạy, một loader-linker sẽ được kernel gọi lên để load và link các thư viện động.<br />
Gọi là loader-linker.<br />
Thường sẽ có nằm ở <strong>/lib/ld.ABC.so</strong> hoặc tương tự như thế.<br />
Loader-linker này sẽ tìm các thư viện được yêu cầu từ Search Path, sau đó link lại để tạo ra chương trình chạy.<br />
Search Path này được cấu thành từ nhiều loại như: từ các path được đặt bên trong <strong>/etc/ld.conf.so</strong>, từ biến <strong>LD_LIBRARY_PATH</strong>, etc. Xem thêm tại: <a href="http://man7.org/linux/man-pages/man8/ld.so.8.html">ld.so</a></p>

<p>Một cách để xem các thông tin debug của loader-linker này:<br />
Giả sử với <strong>HelloWorld</strong> ở trên:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#00688b">LD_DEBUG</span>=<span style="color:#658b00">help</span> ./helloworld_dynamic  
Valid options <span style="color:#8b008b;font-weight:bold">for</span> the LD_DEBUG environment variable are:

libs display library search paths  
reloc display relocation processing  
files display progress <span style="color:#8b008b;font-weight:bold">for</span> input file  
symbols display symbol table processing  
bindings display information about symbol binding  
versions display version dependencies  
scopes display scope information  
all all previous options combined  
statistics display relocation statistics  
unused determined unused DSOs  
<span style="color:#658b00">help</span> display this <span style="color:#658b00">help</span> message and <span style="color:#658b00">exit</span>

To direct the debugging output into a file instead of standard output  
a filename can be specified using the LD_DEBUG_OUTPUT environment variable.  </code></pre></div>
<p>Trên là Help, ta thử với <strong>libs</strong> sẽ có kết quả như sau:</p>
<div class="highlight"><pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#00688b">LD_DEBUG</span>=libs ./helloworld_dynamic  
<span style="color:#b452cd">7066</span>: find <span style="color:#00688b">library</span>=libc.so.6 [<span style="color:#b452cd">0</span>]; searching  
<span style="color:#b452cd">7066</span>: search <span style="color:#00688b">cache</span>=/etc/ld.so.cache  
<span style="color:#b452cd">7066</span>: trying <span style="color:#00688b">file</span>=/lib/i386-linux-gnu/libc.so.6  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>: calling init: /lib/i386-linux-gnu/libc.so.6  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>: initialize program: ./helloworld_dynamic  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>: transferring control: ./helloworld_dynamic  
<span style="color:#b452cd">7066</span>:  
Hello, Ajinomoto  
<span style="color:#b452cd">7066</span>:  
<span style="color:#b452cd">7066</span>: calling fini: ./helloworld_dynamic [<span style="color:#b452cd">0</span>]  
<span style="color:#b452cd">7066</span>:  </code></pre></div>
<p>doime 09-12-2016</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/compiler/" rel="tag">Compiler</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/helloworld/" rel="tag">HelloWorld</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/linker/" rel="tag">Linker</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/loader/" rel="tag">Loader</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-blog-lazytrick-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick.
			<span class="footer__copyright-credits">Convert nội dung Markdown sang HTML bằng <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and sử dụng theme <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>