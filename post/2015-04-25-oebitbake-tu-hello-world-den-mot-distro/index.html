<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>[OE]Bitbake - Từ Hello World đến một Distro - Lazytrick</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick" rel="home">
				<div class="logo__title">Lazytrick</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Posts</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">About</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[OE]Bitbake - Từ Hello World đến một Distro</h1>
			
		</header><div class="content post__content clearfix">
			<p><img src="{{ site.baseurl }}/assets/user-configuration.png?w=300" alt="user-configuration" /></p>

<p>Bitbake là một công cụ cốt lõi của <a href="https://www.yoctoproject.org/about">Yocto Project</a>. Nó bao gồm 1 bộ thông dịch các script được viết trong các file recipe (công thức tạo phần mềm), và thực hiện các lệnh trong đó. Nó mô tả lại và tự động hóa qúa trình người ta đưa một phần mềm vào một distro.</p>

<p>Về việc đưa một phần mềm vào distro, ta có thể thấy nó bao gồm vài step chính. Từ việc tải source code (ở đây là tải source code chứ không phải các gói đã được build sẵn đâu nhé, nó gần giống với ArchLinux, Gentoo và hoàn toàn khác với Ubuntu) , thực hiện các bản patch (sửa source hoặc kịch bản build đề phù hợp mục đích sử dụng), biên dịch, cuối cùng là tích hợp vào distro (kèm theo các thông số cấu hình).</p>

<p>Mục đích của bitbake là tạo ra một quy trình tự động mà đầu vào là các file kịch bản, bitbake sẽ tự làm các công việc còn lại. Ý tưởng của bitbake thực sự rất hay, dù rằng để áp dụng thực tế một cách nuột nà thì cần khá nhiều công sức để hiểu cách nó làm việc với các công cụ truyền thống.</p>

<p>(Link gốc của <a href="http://hambedded.org/blog/2012/11/24/from-bitbake-hello-world-to-an-image/">bài</a>)</p>

<p>OpenEmbedded (OE) và Yocto Project (YP) sử dụng <strong>Bitbake</strong> là công cụ chính.</p>

<p>Sẽ rất có ích cho việc hiểu về OE nếu ta hiểu BitBake ở mức độ nào đó thông qua các task (task ở đây xoanh quanh các xử lý của source code như tải, patch, build như đã nỏi ở trên), các class được định nghĩa trong OE.</p>

<p>Tài liệu này với mong muốn đưa ra một bức tranh mô tả việc tạo ra một Image (ảnh của một Distro) sử dụng OE và YP. Nó sẽ bắt đầu từ một project rất đơn giản sử dụng bitbake. Thông qua project đó sẽ giải thích các khái niệm quan trọng từ các OE class, cuối cùng là chỉ ra quá trình tạo một Image.</p>

<ol>
<li>Về Bitbake</li>
<li>Tải Bitbake</li>
</ol>

<h2 id="1-bitbake-là-cái-gì">1. BITBAKE là cái gì?</h2>

<p>Về cơ bản, khi được chạy nó đọc vào các tasks định nghĩa trong các bitbake metadata(.bbclass, .bb), làm rõ các phụ thuộc (phụ thuộc) giữa chúng, đặt chúng theo một thứ tự và chạy các task cho các metadata đó. Ví dụ như cài dể build một gói A thì phải build gói B trước, tải source nó ở địa chỉ nào etc, các thông tin như thế sẽ nằm trong các file metadata.</p>

<p>(Ở đây có khái niệm metadata, tức là phần siêu dữ liệu chứ không phải dữ liệu chính.)</p>

<p>Bitbake là 1 hệ thống build source code, data của nó là source code, các bản patch.</p>

<p>Còn metadata là các file phục vụ quá trình buid như định nghĩa các biến môi trường, trình biên dịch, máy đích để chạy code sau khi biên dịch.</p>

<p>Bạn có thể nghĩ 1 task như 1 function sẽ được thiết lập để chạy trước hoặc sau một function (task) khác.</p>

<p>Trước khi chúng ta bắt đầu với ví dụ Hello World. Tôi muốn nhắc lại rằng, cái mà  bitbake sẽ đọc và hiểu là các file metadata. Nó có cú pháp riêng của nó giống như một ngôn ngữ lập trình vậy. Nó không giống như các chương trình shell phổ biến khác, đừng nhầm lẫn đấy.</p>

<p>Bạn có thể đọc thêm về ở metadata section của bitbake manual (đang được dịch)</p>

<h2 id="2-lấy-bitbake-về">2. LẤY BITBAKE VỀ</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget http://git.openembedded.org/bitbake/snapshot/bitbake-1.16.0.tar.bz2  
tar xvf bitbake-1.16.0.tar.bz2  
<span class="nb">cd</span> bitbake-1.16.0<span class="p">&amp;</span>lt<span class="p">;</span>/code<span class="p">&amp;</span>gt<span class="p">;</span></code></pre></div>
<p>Thay vì cài đặt, trong bài này ta sẽ chạy nó từ thư mục buil bằng cách add PATH.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="se">\#</span> FIXME: how to disable xml doc generation? It takes a little <span class="nb">time</span> <span class="k">for</span> this doc.  
python setup.py build  
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/build/lib</code></pre></div>
<h2 id="3-build-thử">3. Build thử</h2>

<p>Chúng ta sẽ đi vào một project cụ thẻ.  <em>Hello World Project</em>
Bắt đầu với những ví dụ kinh điển nhất, chúng ta sẽ tìm hiểu cách BitBake làm việc bằng cách chơi với chúng.
Trong phần này, chúng ta sẽ cover những phần sau:</p>

<ul>
<li>Task là cái gì, được định nghĩa như thế nào, task được ghi đè như thế nào.<br /></li>
<li>Flag là cái gì, Flag được sử dụng như thế nào trong BitBake.<br /></li>
</ul>

<p>Với những thành phần như vậy chúng ta sẽ xem làm thế nào chúng được kết hợp với nhau trong một hệ thống build để taojra một Embedded Linux Image. Sau đó chúng ta sẽ vào xem Code của OpenEmbedded và xem những gì đã học được thực hiện như thế nào.</p>

<p>Chú ý : Phần này được viết với sự trợ giúp từ những <a href="http://www.mail-archive.com/yocto@yoctoproject.org/msg09379.html">email </a>được gửi trong Yocto Project Mailing List.</p>

<p>Trong thư mục bitbake được giải nén ở trên, bạn sẽ thấy có file class/base.class.<br />
Nó bao gồm 1 vài hàm cho việc in ra các info, warning, 3 hàm showdata, listtasks, build.</p>

<p>Khi bitbake được chay để build một recipe, mặc định rằng bất kì recipe nào cũng kế thừa file này. Đây là một nơi lý tưởng cho chúng ta định nghĩa build logic. Nếu bạn đã quen với việc build prorams cho UNIX-like OS, bạn chắc chắn sẽ biết rằng, việc build bao gồm những công đoạn sau.</p>

<ul>
<li>Fetch source về.</li>
<li>Giải nén</li>
<li>Patch</li>
<li>Cấu hình</li>
<li>Biên dịch (making)</li>
<li>Cài đặt (nếu cần thiết)</li>
</ul>

<p>Giờ cùng xem những công được này được thực hiện như thế nào.</p>

<h3 id="3-1-thêm-task">3.1 Thêm task</h3>

<pre><code>Syntax : addtask
</code></pre>

<p>Câu trên chỉ giống như khai bao tên hàm.<br />
Code của task được định nghĩa như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">do_</span> <span class="p">{</span>

<span class="p">}</span>  </code></pre></div>
<p>Phần code này có thể là python hoặc shell.<br />
Chúng ta cùng định nghĩa build logic.<br />
Giờ edit file <code>base.bbclas</code> và thay đổi nó thành như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">bbplain</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;$*&#34;</span>  
<span class="p">}</span>

<span class="n">bbnote</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;NOTE: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bbwarn</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;WARNING: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bberror</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;ERROR: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bbfatal</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;ERROR: $*&#34;</span>
  <span class="nb">exit</span> <span class="mi">1</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">fetch</span>  
<span class="n">python</span> <span class="n">base_do_fetch</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bb</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s2">&#34;BASE_DO_FETCH&#34;</span><span class="p">)</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">unpack</span> <span class="n">after</span> <span class="n">do_fetch</span>  
<span class="n">python</span> <span class="n">base_do_unpack</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bb</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s2">&#34;BASE_DO_UNPACK&#34;</span><span class="p">)</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">patch</span> <span class="n">after</span> <span class="n">do_unpack</span>  
<span class="n">base_do_patch</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_PATCH&#34;</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">configure</span> <span class="n">after</span> <span class="n">do_patch</span>  
<span class="n">base_do_configure</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_CONFIGURE&#34;</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">make</span> <span class="n">after</span> <span class="n">do_configure</span>  
<span class="n">base_do_make</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_MAKE&#34;</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">install</span> <span class="n">after</span> <span class="n">do_make</span>  
<span class="n">base_do_install</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_INSTALL&#34;</span>  
<span class="p">}</span>

<span class="n">addtask</span> <span class="n">build</span> <span class="n">after</span> <span class="n">do_install</span>  
<span class="n">base_do_build</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bbnote</span> <span class="s2">&#34;DO_BUILD&#34;</span>  
<span class="p">}</span>

<span class="n">EXPORT_FUNCTIONS</span> <span class="n">do_fetch</span> <span class="n">do_unpack</span> <span class="n">do_patch</span> <span class="n">do_configure</span> <span class="n">do_make</span> <span class="n">do_install</span> <span class="n">do_build</span></code></pre></div>
<p>Như bạn đã thấy, ở code ở trên có 2 hàm là <code>python</code>, còn lại là <code>shell</code>.<br />
Việc in ra tên function ở trên khiến cho việc đọc lại logic dễ dàng hơn từ logs.</p>

<p>Chúng ta sẽ thấy được build logic từ cách làm trên nhưng sẽ tốt hơn nếu tách riêng chúng ra thành module cho việc logging.<br />
Chúng ta cùng tạo một <strong>logging.bblass</strong> trong thư mục <em>classes/</em>. File <strong>logging.bbclass</strong> trông sẽ giống như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="err">`</span><span class="n">bbplain</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;$*&#34;</span>  
<span class="p">}</span><span class="err">`</span>

<span class="n">bbnote</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;NOTE: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bbwarn</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;WARNING: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bberror</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;ERROR: $*&#34;</span>  
<span class="p">}</span>

<span class="n">bbfatal</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">echo</span> <span class="s2">&#34;ERROR: $*&#34;</span>
  <span class="nb">exit</span> <span class="mi">1</span>  
<span class="p">}</span></code></pre></div>
<p>Chúng ta sẽ kế thừa module logging bằng cách như sau, file này là base.bbclass như đã được<br />
nói đến ở trên.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">inherit</span> <span class="n">logging</span>

<span class="n">addtask</span> <span class="n">fetch</span>  
<span class="n">python</span> <span class="n">base_do_fetch</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bb</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s2">&#34;BASE_DO_FETCH&#34;</span><span class="p">)</span>  
<span class="p">}</span></code></pre></div>
<p>Khi file này được parse, các hàm được định nghĩa ở loggging sẽ được kế thừa.<br />
Kế thừa là một trong rất nhiều cách để thực hiện module hóa trong BitBake.</p>

<h3 id="3-2-thêm-1-lớp-mới">3.2 Thêm 1 lớp mới</h3>

<p>Tạo một thư mục tên <strong>meta-test</strong> trong thư mục hiện tại (thư mục giải nén bitbake).<br />
Giờ chúng ta phải cho BitBake biết rằng chúng ta có 1 layer.<br />
Cách làm như sau, tạo file <strong>conf/bblayers.conf</strong> với nội dung như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">BBPATH</span> <span class="p">:</span><span class="o">=</span> <span class="s2">&#34;${TOPDIR}&#34;</span>  
<span class="n">BBFILES</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;&#34;</span>  
<span class="n">BBLAYERS</span> <span class="o">=</span> <span class="s2">&#34; \  </span>
<span class="err">$</span><span class="p">{</span><span class="n">TOPDIR</span><span class="p">}</span><span class="o">/</span><span class="n">meta</span><span class="o">-</span><span class="n">test</span> \  
<span class="s2">&#34;</span></code></pre></div>
<p>Biến ${TOPDIR} ta thấy chưa được nhắc đến. Khi parse đến file này mà biến vẫn chưa định nghĩa, thì BitBake sẽ tự địn nghĩa.<br />
Trong source code của BitBake có đoạn như sau:</p>

<pre><code>_lib/bb/parse/parse_py/ConfHandler.py:36._   
(...)

def init(data):  
topdir = data.getVar('TOPDIR')  
if not topdir:  
data.setVar('TOPDIR', os.getcwd())

(...)
</code></pre>

<p>Bạn sẽ thấy rằng, nếu chưa được định nghĩa thì TOPDIR sẽ là đường dẫn đến thư mục chạy BitBake.<br />
Vậy các biến được gán giá trị ở đây :BBPATH, BBFILES, BBLAYERS sẽ được sử dụng để nhằm mục đích gì?<br />
Trong manual của Bitbake có đoạn như sau:
<a href="http://docs.openembedded.org/bitbake/html/ch02s03.html">http://docs.openembedded.org/bitbake/html/ch02s03.html</a></p>

<blockquote>
<p>Bitbake will first search the current working directory for an optional<br />
&ldquo;conf/bblayers.conf&rdquo; configuration file. This file is expected to contain a<br />
BBLAYERS variable which is a space delimited list of &lsquo;layer&rsquo; directories. For<br />
each directory in this list a &ldquo;conf/layer.conf&rdquo; file will be searched for and<br />
parsed with the LAYERDIR variable being set to the directory where the layer was<br />
found. The idea is these files will setup BBPATH and other variables correctly<br />
for a given build directory automatically for the user.</p>

<p>Bitbake will then expect to find &lsquo;conf/bitbake.conf&rsquo; somewhere in the user<br />
specified BBPATH. That configuration file generally has include directives<br />
to pull in any other metadata (generally files specific to architecture,<br />
machine, local and so on.</p>
</blockquote>

<p>dịch ra là</p>

<blockquote>
<p>Đầu tiên BitBake sẽ search trong thư mục hiện tại để tìm file conf/bblayers.conf.<br />
Nhiệm vụ của file này thông thường sẽ chứa giá trị biến BBLAYERS. Biến này là một danh sách<br />
các thư mục của các layer.(như ta vừa tạo ở trên đó là 1 thư mục cho 1 layer).<br />
Mỗi thư mục trong danh sách trên, BitBake sẽ tìm kiếm lần lượt.<br />
Trong mỗi thư mục, nó sẽ tìm kiếm conf/layers.conf trước tiên. Trong file layers.conf này<br />
nó sẽ đọc để gán giá trị cho biến LAYERDIR. Biến này, tiếp theo đó được sử dụng để xác định<br />
thư mục có chứa các LAYER.<br />
Ý tưởng việc sinh ra các file này nhằm mục đích sẽ gán giá trị biến BBPATH và các biến môi trường khác<br />
một cách chính xác để phục vụ việc build.</p>
</blockquote>

<p>Biến BBPATH cũng tương tự như biến môi trường PATH.
Các file configuration có thể chưa các file configure khác.<br />
Việc xác định đường dẫn tuyết đối của các file này được thực hiện bằng thao tác search<br />
đường dấn tương đối trong các thư mục được liệt kê trong BBPATH, cái tìm thấy trước sẽ được sử dụng.</p>

<p>Như đã nói ở trên, ta cần tạo file conf/layer.conf cho layer meta-test.<br />
Nội dung sẽ như sau:</p>

<pre><code>BBPATH .= &quot;:${LAYERDIR}&quot;

BBFILES += &quot;${LAYERDIR}/recipes-_/_/_.bb \  
${LAYERDIR}/recipes-_/_/_.bbappend&quot;

BBFILE_COLLECTIONS += &quot;test&quot;  
BBFILE_PATTERN_test := &quot;^${LAYERDIR}/&quot;  
BBFILE_PRIORITY_test = &quot;5&quot;
</code></pre>

<p>Chúng ta sẽ thêm layer của chúng ta vào BBPATH để Bitbake có thể tìm thấy.<br />
Bằng biến BBFILES, chúng ta sẽ chỉ cho Bitbake thấy rằng, chúng ta có những file với mẫu như vậy trong thư mục layer của chúng ta.</p>

<p>Chúng ta hãy tạo một recipe trong thư mục.<br />
<code>mkdir -p meta-test/recipes-example/firstrecipe  
vim meta-test/recipes-example/firstrecipe/firstrecipe_0.0.bb</code></p>

<p>File <strong>firstrecipe_0.0.bb</strong> sẽ có nội dung như sau:<br />
<code>DESCRIPTION = &quot;Our first recipe for bitbake hello world&quot;</code></p>

<p>Ta sẽ có thư mục meta-test được tổ chức như dưới đây:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="p">|</span>-- classes  
<span class="p">|</span> <span class="p">|</span>-- base.bbclass  
<span class="p">|</span>  -- logging.bbclass  
<span class="p">|</span>-- conf  
<span class="p">|</span> <span class="p">|</span>-- bblayers.conf  
<span class="p">|</span> -- bitbake.conf  
<span class="p">|</span>-- meta-test  
<span class="p">|</span> <span class="p">|</span>-- conf  
<span class="p">|</span> <span class="p">|</span>  -- layer.conf  
<span class="p">|</span> -- recipes-example  
<span class="p">|</span> -- firstrecipe  
<span class="p">|</span> -- firstrecipe_0.0.bb  </code></pre></div>
<p>Với cấu trúc thư mục ở trên, ta có thể chạy Bitbake được rồi.<br />
<code>./bin/bitbake firstrecipe -vDD</code></p>

<p>Đến đây, sau khi chạy thành công ta ta sẽ thấy được logic buid package thông qua các log.<br />
Đường dẫn log <strong>tmp/work/firstrecipe-0.0-r0/temp/</strong><br />
trong đường dẫn trên kiểm tra file &ldquo;<strong>run_TASK.PID</strong>&rdquo; ta sẽ thấy được cái gì đã được chạy trong<br />
các task, file <strong>log.task_order</strong> sẽ định nghĩa thứ tự chạy các task của chúng ta.</p>

<p>Nào, giờ hãy thêm code vào các task đã được định nghĩa để hiểu cơ bản chức năng của hệ thống build này.</p>

<h2 id="4-ghi-đè-task">4. Ghi đè task</h2>

<p>Việc định nghĩa logic build các package chưa đủ để tạo một hệ thống build thực sự nào.<br />
Có nhiều cách để thực hiện việc cấu hình, biên dịch, cài đặt thông qua các tool kinh điển như autotoool,<br />
cmake, scons, etc.. Ta sẽ override các hàm <strong>do_configure, do_make, do_instal</strong> cho các recipe khác nhau.</p>

<p>Giả sử <strong>firstrecipe</strong> sử dụng autotools.<br />
có nghĩa là nó sẽ có <strong>configure script</strong>, sau đó chúng ta biên dịch sử dụng <strong>make</strong>,<br />
và cài đặt sử dụng <strong>make install</strong>.<br />
Chúng ta sẽ bắt đầu ngay với việc tạo file <strong>autotools.bbclass</strong> trong <strong>classes/</strong><br />
với nội dung như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">autotools_do_configure</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">bbnote</span> <span class="s2">&#34;AUTOTOOLS_CONFIGURE&#34;</span>  
<span class="p">}</span>

<span class="n">autotools_do_make</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">bbnote</span> <span class="s2">&#34;AUTOTOOLS_MAKE&#34;</span>  
<span class="p">}</span>

<span class="n">autotools_do_install</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">bbnote</span> <span class="s2">&#34;AUTOTOOLS_INSTALL&#34;</span>  
<span class="p">}</span>

<span class="n">EXPORT_FUNCTIONS</span> <span class="n">do_configure</span> <span class="n">do_make</span> <span class="n">do_install</span></code></pre></div>
<p>Kế thừa autotools package trong <strong>firstrecipe</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&#34;Our first recipe for bitbake hello world&#34;</span><span class="err">`</span>

<span class="n">inherit</span> <span class="n">autotools</span></code></pre></div>
<p>chúng ta cùng sẽ chạy lại BitBake với các hàm kế thừa từ autotool package</p>

<p><code>./bin/bitbake firstrecipe -vDD</code></p>

<p>Kiểm tra 2 file log trong thư mục temp để thấy các hàm mới đã được gọi (một cách tự động)<br />
Khi không có kế thừa trong recipi thì code chạy sẽ như thế này.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">do_configure</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">base_do_configure</span>
<span class="p">}</span>

<span class="n">base_do_configure</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_CONFIGURE&#34;</span>
<span class="p">}</span>

<span class="n">bbnote</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">echo</span> <span class="s2">&#34;NOTE: $*&#34;</span>
<span class="p">}</span></code></pre></div>
<p>Hàm của lớp base BitBake base class sẽ được gọi.<br />
Khi sử dụng kế thừa thì nó thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">do_configure</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">base_do_configure</span>
<span class="p">}</span>

<span class="n">base_do_configure</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">bbnote</span> <span class="s2">&#34;BASE_DO_CONFIGURE&#34;</span>
<span class="p">}</span>

<span class="n">bbnote</span><span class="p">()</span> <span class="p">{</span>  
  <span class="n">echo</span> <span class="s2">&#34;NOTE: $*&#34;</span>
<span class="p">}</span></code></pre></div>
<p>Việc gọi các hàm từ lớp kế thừa được thực hiện thông qua từ khóa EXPORT_FUNCTIONS.<br />
Khi từ khóa này được sử dụng được dunjgthif do_xxx sẽ được map đến autotools_do_xxx.</p>

<p>Kết luận nhỏ : Đến đây, ta có thể hiểu được bộ khung hay logic của quá trình build package sử dụng<br />
BitBake.</p>

<h2 id="5-áp-dụng-trên-openembedded">5. Áp dụng trên OpenEmbedded</h2>

<p>OpenEmbedded(OE) cung cấp một hệ thống build hoàn chỉnh và rất nhiều recipe.<br />
Nó có rất code, script để phục vụ các giai đoạn trong quá trình như:<br />
tải source code, patching (chỉnh sửa lại để phù hợp mục đích build thường là để<br />
tương tích với target), biên dịch, cài đặt, đóng gọi package ipk, deb, rpm, cả việc<br />
tạo ảnh hệ thống nữa.<br />
Ngoài ra OE còn cung cấp các tính năng khác như caching,&hellip; Sẽ bàn ở một bài khác.</p>

<p><a href="https://www.yoctoproject.org/docs/current/yocto-project-qs/figures/yocto-environment.png"><img src="{{ site.baseurl }}/assets/yocto-environment.png" alt="" /></a> Cấu trúc của OpenEmbedded</p>

<p>Từ hình ta thấy các quá trình chuyển từ code sang các package, image, SDK.<br />
Trong bài này, chúng ta không bàn về chi tiết.<br />
Từ những điều đã biết ở trên về Hell World, hãy thử chúng được áp dụng như thế nào trong OE.</p>

<p>Tải source code</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget http://downloads.yoctoproject.org/releases/yocto/yocto-1.3/poky-danny-8.0.tar.bz2  
tar xvf poky-danny-8.0.tar.bz2  
<span class="nb">cd</span> poky-danny-8.0</code></pre></div>
<p>Như chúng ta đã nói ở trên, bitbake.conf sẽ được parse khi bitbake được chạy. File là một trong những file cấu hình quan trọng của OE.<br />
Vị trí file này</p>

<p><strong>meta/conf/bitbake.conf</strong></p>

<p>File cấu hình này có thể được module hóa, ở đây chúng được chia ra làm nhiều file.<br />
Nội dung file sẽ có dòng như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">include conf/build/<span class="si">${</span><span class="nv">BUILD_SYS</span><span class="si">}</span>.conf  
include conf/target/<span class="si">${</span><span class="nv">TARGET_SYS</span><span class="si">}</span>.conf  
include conf/machine/<span class="si">${</span><span class="nv">MACHINE</span><span class="si">}</span>.conf  
include conf/machine-sdk/<span class="si">${</span><span class="nv">SDKMACHINE</span><span class="si">}</span>.conf  
include conf/distro/<span class="si">${</span><span class="nv">DISTRO</span><span class="si">}</span>.conf</code></pre></div>
<p>Các file configure này sẽ được search trong các thư mục được định nghĩa ở BBPATH.<br />
Điều đó có nghĩa là khi BitBake chạy, những file cấu hình này sẽ được searched trong tất các<br />
các layer bạn định nghĩa. Cái tìm thấy đầu tiên sẽ được sử dụng.<br />
Nhớ rằng, đường dẫn của tất cả các LAYER sẽ được thêm vào BBPATH.<br />
và có đến 99% số biến được định nghĩa trong <code>bitbake.conf</code>, còn lại là các file include.</p>

<h2 id="6-các-task">6. Các task</h2>

<p>Để hiểu về kiến trúc của OE, điều quan trọng đầu tiên ta phải biết là các task được định nghĩa ở đâu.<br />
Chúng ta đã được thấy file <strong>base.bbclass</strong> là một nơi lý tưởng để định nghĩa logic và các code chúng.<br />
tất cả các file bbclass được định nghĩa trong <em>meta/classes/</em>.<br />
Mở file base.bbclass và search &ldquo;addtask&rdquo; keyword, ta sẽ thấy nội dung sẽ giống như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">...</span>  
<span class="n">addtask</span> <span class="n">fetch</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">unpack</span> <span class="n">after</span> <span class="n">do_fetch</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">configure</span> <span class="n">after</span> <span class="n">do_patch</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="nb">compile</span> <span class="n">after</span> <span class="n">do_configure</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">install</span> <span class="n">after</span> <span class="n">do_compile</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">build</span> <span class="n">after</span> <span class="n">do_populate_sysroot</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">cleansstate</span> <span class="n">after</span> <span class="n">do_clean</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">cleanall</span> <span class="n">after</span> <span class="n">do_cleansstate</span></code></pre></div>
<p>Tuy nhiên, trong file này không chỉ có những task này được định nghĩa.<br />
Có những task được định nghĩa trong <strong>{patch, staging}.</strong>bbclass.<br />
Chúng ta cùng nhau xem task nào được định nghĩa.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">//</span> <span class="n">patch</span><span class="o">.</span><span class="n">bbclass</span>  
<span class="n">addtask</span> <span class="n">patch</span> <span class="n">after</span> <span class="n">do_unpack</span><span class="err">`</span>

<span class="o">//</span> <span class="n">staging</span><span class="o">.</span><span class="n">bbclass</span>  
<span class="n">addtask</span> <span class="n">populate_sysroot</span> <span class="n">after</span> <span class="n">do_install</span>  
<span class="n">addtask</span> <span class="n">do_populate_sysroot_setscene</span></code></pre></div>
<p>Những task này cũng vẫn chưa đủ. Trong file bitbake.còn, ta thấy file conf.distro/defaultsetup.conf được<br />
include. Nó định nghĩa các packagage sau đây được kế thừa.</p>

<p><code>_package_ipk, insane, debian devshell sstate license_</code></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">USER_CLASSES</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;&#34;</span>  
<span class="n">PACKAGE_CLASSES</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;package_ipk&#34;</span>  
<span class="n">INHERIT_INSANE</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;insane&#34;</span>  
<span class="n">INHERIT_DISTRO</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;debian devshell sstate license&#34;</span>  
<span class="n">INHERIT</span> <span class="o">+=</span> <span class="s2">&#34;${PACKAGE_CLASSES} ${USER_CLASSES} ${INHERIT_INSANE} ${INHERIT_DISTRO}&#34;</span></code></pre></div>
<p>Trong các bbclass file, có 1 file liên quan tưới việc quản lý các gói/<br />
Ta cùng tìm hiểu 1 loại dễ nhất là package_ipk.bblcass. File này được kế thừa package.bbclass.<br />
File package.bbclass sẽ định nghĩa logic build, như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">...</span>
<span class="n">addtask</span> <span class="n">package</span> <span class="n">before</span> <span class="n">do_build</span> <span class="n">after</span> <span class="n">do_install</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">do_package_setscene</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">package_write</span> <span class="n">before</span> <span class="n">do_build</span> <span class="n">after</span> <span class="n">do_package</span></code></pre></div>
<p>Thứ tự là install -&gt; packaging.<br />
Vì vậy task cũng đượ địnhg nghĩa như vậy.<br />
Với mỗi loại package khác nhau, ipk, deb, rpm&hellip;<br />
Chúng ta cùng tìm hiểu loại dễ nhất là ipk.<br />
Nó định nghĩa như sau :</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">...</span>  
<span class="n">addtask</span> <span class="n">do_package_write_ipk_setscene</span>

<span class="o">...</span>  
<span class="n">python</span> <span class="n">do_package_write_ipk</span> <span class="p">()</span> <span class="p">{</span>  
<span class="n">bb</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">exec_func</span><span class="p">(</span><span class="s2">&#34;read_subpackage_metadata&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  
<span class="n">bb</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">exec_func</span><span class="p">(</span><span class="s2">&#34;do_package_ipk&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  
<span class="p">}</span>

<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">package_write_ipk</span> <span class="n">before</span> <span class="n">do_package_write</span> <span class="n">after</span> <span class="n">do_package</span></code></pre></div>
<p>Như bạn thấy, khi package_write_ipk được chạy, nó sẽ gọi <strong>read_subpackage_metadata</strong><br />
và thực hiện hàm do_package_ipk để tạo ipk package.<br />
Nhưng gói khác cũng tương tự như vậy.</p>

<h2 id="7-package-group">7. Package Group</h2>

<p>Quan hệ giữa các gọi được sử dụng để cung cấp một gói ảo (virtual package), cái mà có cùng chức năng.<br />
cái này xử lý thông qua <strong>package groups</strong> trong OE.<br />
Package group có thể được xem như package ảo, chúng có các gói phụ thuộc.</p>

<p>Package groups nằm ở <em>recipes-packagegroups</em>. Chúng là các bitbake recipes như &ldquo;busybox&rdquo; hoặc<br />
&ldquo;tinylogin&rdquo;. Tuy nhiên chúng không có source để build, chúng phụ thuộc vào những gói khác để cung cấp<br />
chức năng. Bên dưới là danh sách các package groups trong OE-core layer<br />
ta hãy xem có những group nào</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">% find meta/recipes-*/packagegroups -type d <span class="p">|</span> xargs tree --charset<span class="o">=</span>utf

meta/recipes-core/packagegroups  
<span class="p">|</span>-- nativesdk-packagegroup-sdk-host.bb  
<span class="p">|</span>-- packagegroup-base.bb  
<span class="p">|</span>-- packagegroup-core-boot.bb  
<span class="p">|</span>-- packagegroup-core-buildessential.bb  
<span class="p">|</span>-- packagegroup-core-nfs.bb  
<span class="p">|</span>-- packagegroup-core-sdk.bb  
<span class="p">|</span>-- packagegroup-core-ssh-dropbear.bb  
<span class="p">|</span>-- packagegroup-core-ssh-openssh.bb  
<span class="p">|</span>-- packagegroup-core-standalone-sdk-target.bb  
<span class="p">|</span>-- packagegroup-core-tools-debug.bb  
<span class="p">|</span>-- packagegroup-core-tools-profile.bb  
<span class="p">|</span>-- packagegroup-core-tools-testapps.bb  
<span class="p">|</span>-- packagegroup-cross-canadian.bb  
<span class="p">|</span>-- packagegroup-self-hosted.bb  
meta/recipes-devtools/packagegroups-- packagegroup-core-device-devel.bb  
meta/recipes-extended/packagegroups  
<span class="p">|</span>-- packagegroup-core-basic.bb  
<span class="p">|</span>-- packagegroup-core-lsb.bb  
meta/recipes-gnome/packagegroups  
<span class="p">|</span>-- packagegroup-core-sdk-gmae.bb  
<span class="p">|</span>-- packagegroup-core-standalone-gmae-sdk-target.bb<span class="sb">`</span>-- packagegroup-sdk-gmae.inc  
meta/recipes-graphics/packagegroups  
<span class="p">|</span>-- packagegroup-core-clutter.bb  
<span class="p">|</span>-- packagegroup-core-gtk-directfb.bb  
<span class="p">|</span>-- packagegroup-core-x11-base.bb  
<span class="p">|</span>-- packagegroup-core-x11-xserver.bb  
<span class="p">|</span>-- packagegroup-core-x11.bb  
meta/recipes-qt/packagegroups  
<span class="p">|</span>-- nativesdk-packagegroup-qte-toolchain-host.bb  
<span class="p">|</span>-- packagegroup-core-qt.bb  
<span class="p">|</span>-- packagegroup-core-qt4e.bb-- packagegroup-qte-toolchain-target.bb  
meta/recipes-sato/packagegroups  
<span class="p">|</span>-- packagegroup-core-x11-sato.bb</code></pre></div>
<p>Quá nhiều, ta chỉ xét 1 cái thôi. Đó là <strong>packagegroup-core-boot</strong><br />
Đây là group sẽ yêu cầu các package để có thể boot hệ thống.<br />
Nào cùng tìm hiểu về nó</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">meta</span><span class="o">/</span><span class="n">recipes</span><span class="o">-</span><span class="n">core</span><span class="o">/</span><span class="n">packagegroups</span><span class="o">/</span><span class="n">packagegroup</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">boot</span><span class="o">.</span><span class="n">bb</span>  

<span class="c1">#``Copyright (C) 2007 OpenedHand Ltd.</span>
<span class="o">==================================</span><span class="err">`</span>

<span class="sb">`#`</span>

<span class="n">SUMMARY</span> <span class="o">=</span> <span class="s2">&#34;Minimal boot requirements&#34;</span>  
<span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&#34;The minimal set of packages required to boot the system&#34;</span>  
<span class="n">LICENSE</span> <span class="o">=</span> <span class="s2">&#34;MIT&#34;</span>  
<span class="n">DEPENDS</span> <span class="o">=</span> <span class="s2">&#34;virtual/kernel&#34;</span>  
<span class="n">PR</span> <span class="o">=</span> <span class="s2">&#34;r10&#34;</span>

<span class="n">inherit</span> <span class="n">packagegroup</span>

<span class="n">PACKAGE_ARCH</span> <span class="o">=</span> <span class="s2">&#34;${MACHINE_ARCH}&#34;</span>

\<span class="c1">#</span>

<span class="n">Set</span> <span class="n">by</span> <span class="n">the</span> <span class="n">machine</span> <span class="n">configuration</span> <span class="k">with</span> <span class="n">packages</span> <span class="n">essential</span> <span class="k">for</span> <span class="n">device</span> <span class="n">bootup</span>
<span class="o">==========================================================================</span>

\<span class="c1">#  </span>
<span class="n">MACHINE_ESSENTIAL_EXTRA_RDEPENDS</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;&#34;</span>  
<span class="n">MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;&#34;</span>

<span class="n">For</span> <span class="n">backwards</span> <span class="n">compatibility</span> <span class="n">after</span> <span class="n">rename</span>
<span class="o">========================================</span>

<span class="n">RPROVIDES_</span><span class="err">$</span><span class="p">{</span><span class="n">PN</span><span class="p">}</span> <span class="o">=</span> <span class="s2">&#34;task-core-boot&#34;</span>  
<span class="n">RREPLACES_</span><span class="err">$</span><span class="p">{</span><span class="n">PN</span><span class="p">}</span> <span class="o">=</span> <span class="s2">&#34;task-core-boot&#34;</span>  
<span class="n">RCONFLICTS_</span><span class="err">$</span><span class="p">{</span><span class="n">PN</span><span class="p">}</span> <span class="o">=</span> <span class="s2">&#34;task-core-boot&#34;</span>

<span class="n">Distro</span> <span class="n">can</span> <span class="n">override</span> <span class="n">the</span> <span class="n">following</span> <span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME</span> <span class="n">providers</span><span class="p">:</span>
<span class="o">============================================================</span>

<span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_dev_manager</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;udev&#34;</span>  
<span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_login_manager</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;tinylogin&#34;</span>  
<span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_init_manager</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;sysvinit&#34;</span>  
<span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_initscripts</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;initscripts&#34;</span>  
<span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_keymaps</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;keymaps&#34;</span>

<span class="n">RDEPENDS_</span><span class="err">$</span><span class="p">{</span><span class="n">PN</span><span class="p">}</span> <span class="o">=</span> <span class="s2">&#34;\  </span>
<span class="n">base</span><span class="o">-</span><span class="n">files</span> \  
<span class="n">base</span><span class="o">-</span><span class="n">passwd</span> \  
<span class="n">busybox</span> \  
<span class="err">$</span><span class="p">{</span><span class="nd">@base_contains</span><span class="p">(</span><span class="s2">&#34;MACHINE_FEATURES&#34;</span><span class="p">,</span> <span class="s2">&#34;rtc&#34;</span><span class="p">,</span> <span class="s2">&#34;busybox-hwclock&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">)}</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_initscripts</span><span class="p">}</span> \  
<span class="err">$</span><span class="p">{</span><span class="nd">@base_contains</span><span class="p">(</span><span class="s2">&#34;MACHINE_FEATURES&#34;</span><span class="p">,</span> <span class="s2">&#34;keyboard&#34;</span><span class="p">,</span> <span class="s2">&#34;${VIRTUAL-RUNTIME_keymaps}&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">)}</span> \  
<span class="n">modutils</span><span class="o">-</span><span class="n">initscripts</span> \  
<span class="n">netbase</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_login_manager</span><span class="p">}</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_init_manager</span><span class="p">}</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_dev_manager</span><span class="p">}</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">VIRTUAL</span><span class="o">-</span><span class="n">RUNTIME_update</span><span class="o">-</span><span class="n">alternatives</span><span class="p">}</span> \  
<span class="err">$</span><span class="p">{</span><span class="n">MACHINE_ESSENTIAL_EXTRA_RDEPENDS</span><span class="p">}</span><span class="s2">&#34;</span>

<span class="n">RRECOMMENDS_</span><span class="err">$</span><span class="p">{</span><span class="n">PN</span><span class="p">}</span> <span class="o">=</span> <span class="s2">&#34;\  </span>
<span class="err">$</span><span class="p">{</span><span class="n">MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS</span><span class="p">}</span><span class="s2">&#34;</span></code></pre></div>
<p>Biến <strong>RDEPENDS_${PN}</strong> chưa các package sẽ bitbake build.<br />
Các package này cũng được control bằng các tham số được định nghĩa ở trên như<br />
rtc, keyboard,&hellip;.</p>

<h2 id="8-minimal-image">8. Minimal image</h2>

<p>Các recipes Image, tức là chưa đầy đủ các package cho 1 hệ thống.<br />
nằm ở <strong>recipes-*/images/</strong>. Có nhiều loại image với các mục đích khác nhau.<br />
Danh sách có thể được list ra như sau</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">% find meta/recipes-*/images -type d <span class="p">|</span> xargs tree --charset<span class="o">=</span>utf

meta/recipes-core/images  
<span class="p">|</span>-- build-appliance-image  
<span class="p">|</span> <span class="p">|</span>-- Yocto_Build_Appliance.vmx  
<span class="p">|</span> <span class="p">|</span>-- Yocto_Build_Appliance.vmxf  
<span class="p">|</span>-- build-appliance-image.bb  
<span class="p">|</span>-- core-image-base.bb  
<span class="p">|</span>-- core-image-minimal-dev.bb  
<span class="p">|</span>-- core-image-minimal-initramfs.bb  
<span class="p">|</span>-- core-image-minimal-mtdutils.bb-- core-image-minimal.bb  
meta/recipes-core/images/build-appliance-image  
<span class="p">|</span>-- Yocto_Build_Appliance.vmx  
<span class="p">|</span>-- Yocto_Build_Appliance.vmxf  
meta/recipes-extended/images  
<span class="p">|</span>-- core-image-basic.bb  
<span class="p">|</span>-- core-image-lsb-dev.bb  
<span class="p">|</span>-- core-image-lsb-sdk.bb-- core-image-lsb.bb  
meta/recipes-graphics/images  
<span class="p">|</span>-- core-image-clutter.bb  
<span class="p">|</span>-- core-image-gtk-directfb.bb  
<span class="p">|</span>-- core-image-x11.bb  
meta/recipes-qt/images-- qt4e-demo-image.bb  
meta/recipes-rt/images  
<span class="p">|</span>-- core-image-rt-sdk.bb  
<span class="p">|</span>-- core-image-rt.bb  
meta/recipes-sato/images  
<span class="p">|</span>-- core-image-sato-dev.bb  
<span class="p">|</span>-- core-image-sato-sdk.bb-- core-image-sato.bb</code></pre></div>
<p>Minimal image là dễ hiểu nhất. Chúng ta sẽ tìm hiểu 1 chút về nó.<br />
core-image-minimal.<br />
Vậy làm thế nào core-image-minimal được built.</p>

<p>File recipie của core-image-minimal như sau</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">meta/recipes-core/images/core-image-minimal.bb  

<span class="nv">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&#34;A small image just capable of allowing a device to boot.&#34;</span>

<span class="nv">IMAGE_INSTALL</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-boot </span><span class="si">${</span><span class="nv">ROOTFS_PKGMANAGE_BOOTSTRAP</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">CORE_IMAGE_EXTRA_INSTALL</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="nv">IMAGE_LINGUAS</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span>

<span class="nv">LICENSE</span> <span class="o">=</span> <span class="s2">&#34;MIT&#34;</span>

inherit core-image

<span class="nv">IMAGE_ROOTFS_SIZE</span> <span class="o">=</span> <span class="s2">&#34;8192&#34;</span>

remove not needed ipkg <span class="nv">informations</span>
<span class="o">===================================</span>

<span class="nv">ROOTFS_POSTPROCESS_COMMAND</span> <span class="o">+=</span> <span class="s2">&#34;remove_packaging_data_files ; &#34;</span></code></pre></div>
<p>Như các bạn thấy, biến IMAGE_INSTALL chưa <strong>packagegroup-core-boot</strong><br />
Và nó cũng kế thừa một lớp core-image bbclass.</p>

<p>Tìm hiểu qua về core-image</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">meta</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span><span class="n">core</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">bbclass</span>

<span class="n">Common</span> <span class="n">code</span> <span class="k">for</span> <span class="n">generating</span> <span class="n">core</span> <span class="n">reference</span> <span class="n">images</span>
<span class="o">================================================</span>


<span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2007</span><span class="o">-</span><span class="mi">2011</span> <span class="n">Linux</span> <span class="n">Foundation</span>
<span class="o">========================================</span><span class="err">`</span>


<span class="n">LIC_FILES_CHKSUM</span> <span class="o">=</span> <span class="s2">&#34;file://${COREBASE}/LICENSE;md5=3f40d7994397109285ec7b81fdeb3b58 \  </span>
<span class="nb">file</span><span class="p">:</span><span class="o">//</span><span class="err">$</span><span class="p">{</span><span class="n">COREBASE</span><span class="p">}</span><span class="o">/</span><span class="n">meta</span><span class="o">/</span><span class="n">COPYING</span><span class="o">.</span><span class="n">MIT</span><span class="p">;</span><span class="n">md5</span><span class="o">=</span><span class="mi">3</span><span class="n">da9cfbcb788c80a0384361b4de20420</span><span class="s2">&#34;</span>

<span class="n">IMAGE_FEATURES</span> <span class="n">control</span> <span class="n">content</span> <span class="n">of</span> <span class="n">the</span> <span class="n">core</span> <span class="n">reference</span> <span class="n">images</span>
<span class="o">===========================================================</span>


<span class="n">By</span> <span class="n">default</span> <span class="n">we</span> <span class="n">install</span> <span class="n">packagegroup</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">boot</span> <span class="ow">and</span> <span class="n">packagegroup</span><span class="o">-</span><span class="n">base</span> <span class="n">packages</span> <span class="o">-</span> <span class="n">this</span> <span class="n">gives</span> <span class="n">us</span>
<span class="o">===========================================================================================</span>

<span class="n">working</span> <span class="p">(</span><span class="n">console</span> <span class="n">only</span><span class="p">)</span> <span class="n">rootfs</span><span class="o">.</span>
<span class="o">==============================</span>


<span class="n">Available</span> <span class="n">IMAGE_FEATURES</span><span class="p">:</span>
<span class="o">=========================</span>


<span class="o">-</span> <span class="n">x11</span> <span class="o">-</span> <span class="n">X</span> <span class="n">server</span>
<span class="o">================</span>

<span class="o">-</span> <span class="n">x11</span><span class="o">-</span><span class="n">base</span> <span class="o">-</span> <span class="n">X</span> <span class="n">server</span> <span class="k">with</span> <span class="n">minimal</span> <span class="n">environment</span>
<span class="o">==============================================</span>

<span class="o">-</span> <span class="n">x11</span><span class="o">-</span><span class="n">sato</span> <span class="o">-</span> <span class="n">OpenedHand</span> <span class="n">Sato</span> <span class="n">environment</span>
<span class="o">========================================</span>

<span class="o">-</span> <span class="n">tools</span><span class="o">-</span><span class="n">debug</span> <span class="o">-</span> <span class="n">debugging</span> <span class="n">tools</span>
<span class="o">===============================</span>

<span class="o">-</span> <span class="n">tools</span><span class="o">-</span><span class="n">profile</span> <span class="o">-</span> <span class="n">profiling</span> <span class="n">tools</span>
<span class="o">=================================</span>

<span class="o">-</span> <span class="n">tools</span><span class="o">-</span><span class="n">testapps</span> <span class="o">-</span> <span class="n">tools</span> <span class="n">usable</span> <span class="n">to</span> <span class="n">make</span> <span class="n">some</span> <span class="n">device</span> <span class="n">tests</span>
<span class="o">=========================================================</span>

<span class="o">-</span> <span class="n">tools</span><span class="o">-</span><span class="n">sdk</span> <span class="o">-</span> <span class="n">SDK</span> <span class="p">(</span><span class="n">C</span><span class="o">/</span><span class="n">C</span><span class="o">++</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">autotools</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span>
<span class="o">===================================================</span>

<span class="o">-</span> <span class="n">nfs</span><span class="o">-</span><span class="n">server</span> <span class="o">-</span> <span class="n">NFS</span> <span class="n">server</span>
<span class="o">=========================</span>

<span class="o">-</span> <span class="n">ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">dropbear</span> <span class="o">-</span> <span class="n">SSH</span> <span class="n">server</span> <span class="p">(</span><span class="n">dropbear</span><span class="p">)</span>
<span class="o">=============================================</span>

<span class="o">-</span> <span class="n">ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">openssh</span> <span class="o">-</span> <span class="n">SSH</span> <span class="n">server</span> <span class="p">(</span><span class="n">openssh</span><span class="p">)</span>
<span class="o">===========================================</span>

<span class="o">-</span> <span class="n">qt4</span><span class="o">-</span><span class="n">pkgs</span> <span class="o">-</span> <span class="n">Qt4</span><span class="o">/</span><span class="n">X11</span> <span class="ow">and</span> <span class="n">demo</span> <span class="n">applications</span>
<span class="o">==========================================</span>

<span class="o">-</span> <span class="n">package</span><span class="o">-</span><span class="n">management</span> <span class="o">-</span> <span class="n">installs</span> <span class="n">package</span> <span class="n">management</span> <span class="n">tools</span> <span class="ow">and</span> <span class="n">preserves</span> <span class="n">the</span> <span class="n">package</span> <span class="n">manager</span> <span class="n">database</span>
<span class="o">===================================================================================================</span>

<span class="o">-</span> <span class="n">debug</span><span class="o">-</span><span class="n">tweaks</span> <span class="o">-</span> <span class="n">makes</span> <span class="n">an</span> <span class="n">image</span> <span class="n">suitable</span> <span class="k">for</span> <span class="n">development</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">allowing</span> <span class="n">passwordless</span> <span class="n">root</span> <span class="n">logins</span>
<span class="o">================================================================================================</span>

<span class="o">-</span> <span class="n">dev</span><span class="o">-</span><span class="n">pkgs</span> <span class="o">-</span> <span class="n">development</span> <span class="n">packages</span> <span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span><span class="p">)</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">installed</span> <span class="n">packages</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rootfs</span>
<span class="o">==========================================================================================</span>

<span class="o">-</span> <span class="n">dbg</span><span class="o">-</span><span class="n">pkgs</span> <span class="o">-</span> <span class="n">debug</span> <span class="n">symbol</span> <span class="n">packages</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">installed</span> <span class="n">packages</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rootfs</span>
<span class="o">===========================================================================</span>

<span class="o">-</span> <span class="n">doc</span><span class="o">-</span><span class="n">pkgs</span> <span class="o">-</span> <span class="n">documentation</span> <span class="n">packages</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">installed</span> <span class="n">packages</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">rootfs</span>
<span class="o">============================================================================</span>

<span class="n">PACKAGE_GROUP_x11</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-x11&#34;</span>  
<span class="n">PACKAGE_GROUP_x11</span><span class="o">-</span><span class="n">base</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-x11-base&#34;</span>  
<span class="n">PACKAGE_GROUP_x11</span><span class="o">-</span><span class="n">sato</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-x11-sato&#34;</span>  
<span class="n">PACKAGE_GROUP_tools</span><span class="o">-</span><span class="n">debug</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-tools-debug&#34;</span>  
<span class="n">PACKAGE_GROUP_tools</span><span class="o">-</span><span class="n">profile</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-tools-profile&#34;</span>  
<span class="n">PACKAGE_GROUP_tools</span><span class="o">-</span><span class="n">testapps</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-tools-testapps&#34;</span>  
<span class="n">PACKAGE_GROUP_tools</span><span class="o">-</span><span class="n">sdk</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-sdk packagegroup-core-standalone-sdk-target&#34;</span>  
<span class="n">PACKAGE_GROUP_nfs</span><span class="o">-</span><span class="n">server</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-nfs-server&#34;</span>  
<span class="n">PACKAGE_GROUP_ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">dropbear</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-ssh-dropbear&#34;</span>  
<span class="n">PACKAGE_GROUP_ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">openssh</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-ssh-openssh&#34;</span>  
<span class="n">PACKAGE_GROUP_package</span><span class="o">-</span><span class="n">management</span> <span class="o">=</span> <span class="s2">&#34;${ROOTFS_PKGMANAGE}&#34;</span>  
<span class="n">PACKAGE_GROUP_qt4</span><span class="o">-</span><span class="n">pkgs</span> <span class="o">=</span> <span class="s2">&#34;packagegroup-core-qt-demoapps&#34;</span>

<span class="n">IMAGE_FEATURES_REPLACES_foo</span> <span class="o">=</span> <span class="s1">&#39;bar1 bar2&#39;</span>
<span class="o">=========================================</span>

<span class="n">Including</span> <span class="n">image</span> <span class="n">feature</span> <span class="n">foo</span> <span class="n">would</span> <span class="n">replace</span> <span class="n">the</span> <span class="n">image</span> <span class="n">features</span> <span class="n">bar1</span> <span class="ow">and</span> <span class="n">bar2</span>
<span class="o">==========================================================================</span>

<span class="n">IMAGE_FEATURES_REPLACES_ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">openssh</span> <span class="o">=</span> <span class="s2">&#34;ssh-server-dropbear&#34;</span>

<span class="n">IMAGE_FEATURES_CONFLICTS_foo</span> <span class="o">=</span> <span class="s1">&#39;bar1 bar2&#39;</span>
<span class="o">==========================================</span>

<span class="n">An</span> <span class="n">error</span> <span class="n">exception</span> <span class="n">would</span> <span class="n">be</span> <span class="n">raised</span> <span class="k">if</span> <span class="n">both</span> <span class="n">image</span> <span class="n">features</span> <span class="n">foo</span> <span class="ow">and</span> <span class="n">bar1</span><span class="p">(</span><span class="ow">or</span> <span class="n">bar2</span><span class="p">)</span> <span class="n">are</span> <span class="n">included</span>
<span class="o">============================================================================================</span>

<span class="n">python</span> <span class="n">__anonymous</span><span class="p">()</span> <span class="p">{</span>

<span class="n">Ensure</span> <span class="n">we</span> <span class="n">still</span> <span class="n">have</span> <span class="n">a</span> <span class="n">splash</span> <span class="n">screen</span> <span class="k">for</span> <span class="n">existing</span> <span class="n">images</span>
<span class="o">========================================================</span>

<span class="k">if</span> <span class="n">base_contains</span><span class="p">(</span><span class="s2">&#34;IMAGE_FEATURES&#34;</span><span class="p">,</span> <span class="s2">&#34;apps-console-core&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;1&#34;</span><span class="p">:</span>  
<span class="n">bb</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: apps-console-core in IMAGE_FEATURES is no longer supported; adding </span><span class="se">\&#34;</span><span class="s2">splash</span><span class="se">\&#34;</span><span class="s2"> to enable splash screen&#34;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">getVar</span><span class="p">(</span><span class="s2">&#34;PN&#34;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>  
<span class="n">d</span><span class="o">.</span><span class="n">appendVar</span><span class="p">(</span><span class="s2">&#34;IMAGE_FEATURES&#34;</span><span class="p">,</span> <span class="s2">&#34; splash&#34;</span><span class="p">)</span>  
<span class="p">}</span>

<span class="n">CORE_IMAGE_BASE_INSTALL</span> <span class="o">=</span> <span class="s1">&#39;\  </span>
<span class="n">packagegroup</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">boot</span> \  
<span class="n">packagegroup</span><span class="o">-</span><span class="n">base</span><span class="o">-</span><span class="n">extended</span> \  
\  
<span class="err">$</span><span class="p">{</span><span class="n">CORE_IMAGE_EXTRA_INSTALL</span><span class="p">}</span> \  
<span class="s1">&#39;</span>

<span class="n">CORE_IMAGE_EXTRA_INSTALL</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;&#34;</span>

<span class="n">IMAGE_INSTALL</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;${CORE_IMAGE_BASE_INSTALL}&#34;</span>

<span class="n">inherit</span> <span class="n">image</span>

<span class="n">Create</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">timestamp</span> <span class="n">during</span> <span class="n">image</span> <span class="n">construction</span> <span class="n">to</span> <span class="n">give</span> <span class="n">a</span> <span class="n">reasonably</span> <span class="n">sane</span> <span class="n">default</span> <span class="n">time</span> <span class="n">setting</span>
<span class="o">==============================================================================================</span>

<span class="n">ROOTFS_POSTPROCESS_COMMAND</span> <span class="o">+=</span> <span class="s2">&#34;rootfs_update_timestamp ; &#34;</span>

<span class="n">Zap</span> <span class="n">the</span> <span class="n">root</span> <span class="n">password</span> <span class="k">if</span> <span class="n">debug</span><span class="o">-</span><span class="n">tweaks</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">enabled</span>
<span class="o">============================================================</span>

<span class="n">ROOTFS_POSTPROCESS_COMMAND</span> <span class="o">+=</span> <span class="s1">&#39;${@base_contains(&#34;IMAGE_FEATURES&#34;, &#34;debug-tweaks&#34;, &#34;&#34;, &#34;zap_root_password ; &#34;,d)}&#39;</span>

<span class="n">Allow</span> <span class="n">openssh</span> <span class="n">accept</span> <span class="n">empty</span> <span class="n">password</span> <span class="n">login</span> <span class="k">if</span> <span class="n">both</span> <span class="n">debug</span><span class="o">-</span><span class="n">tweaks</span> <span class="ow">and</span> <span class="n">ssh</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">openssh</span> <span class="n">are</span> <span class="n">enabled</span>
<span class="o">=================================================================================================</span>

<span class="n">ROOTFS_POSTPROCESS_COMMAND</span> <span class="o">+=</span> <span class="s1">&#39;${@base_contains(&#34;IMAGE_FEATURES&#34;, &#34;debug-tweaks ssh-server-openssh&#34;, &#34;openssh_allow_empty_password; &#34;, &#34;&#34;,d)}&#39;</span></code></pre></div>
<p>Do biến <code>IMAGE_INSTALL</code> được định nghĩa trước khi kế thừa lớp recipe <code>core-image</code>. Vì thế, giá trị đó vẫn không bị thay đổi khi<br />
parse đến <code>core-image.bbclass</code>.<br />
Ỏ đây ta thấy có xử lý postprogress _rootfs_update<em>timestamp</em><br />
Và cũng phải nhắc đến việc core-image kế thừa từ image</p>

<h2 id="9-vậy-điều-thú-vị-xảy-ra-ở-đâu-có-phải-trong-file-image-bbclass">9. Vậy điều thú vị xảy ra ở đâu, có phải trong file image.bbclass??</h2>

<p>Cuối cùng, đây là nơi mọi chuyện sẽ xảy ra. Hay nói ngắn gọn, ảnh sẽ được tạo từ ipk, deb, ..rpm package.<br />
Vì ipk được sử dụng trong ở trên rồi ) nên ta sẽ tiếp tục với ipk.<br />
Danh sách các package được đưa vào image được đưa ra trong file <strong>package_ipk.bbclass</strong><br />
Nhưng gói trong đó được cài đặt sử dụng <strong>opkg</strong> vào thư mục <strong>rootfs</strong></p>

<p>Vì file image.bbclas rất dài. Ta sẽ chỉ tập trung vào phần code quan trọng thôi đê hiểu quá trình tạo ra<br />
1 image.</p>

<p>Để tạo image cũng như cài đặt vào rootfs.<br />
Đầu tiên các package phải được build đã.</p>

<p>Tuy nhiên chúng ta không định nghĩa bất cứ phụ thuộc vào, mà chỉ là set giá trị biến IMAGE_INSTALL</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">meta</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span><span class="n">image</span><span class="o">.</span><span class="n">bbclass</span>

<span class="o">...</span>  
<span class="n">RDEPENDS</span> <span class="o">+=</span> <span class="s2">&#34;${IMAGE_INSTALL} ${LINGUAS_INSTALL} ${NORMAL_FEATURE_INSTALL} ${ROOTFS_BOOTSTRAP_INSTALL}&#34;</span>

<span class="o">...</span>

<span class="n">definition</span> <span class="n">of</span> <span class="n">which</span> <span class="n">packages</span> <span class="n">should</span> <span class="n">be</span> <span class="n">installed</span> <span class="n">on</span> <span class="n">image</span><span class="o">.</span> <span class="n">PACKAGE_INSTALL</span>
<span class="o">==========================================================================</span>

<span class="n">variable</span> <span class="ow">is</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">rootfs</span> <span class="n">creation</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">rootfs_ipk</span><span class="o">.</span><span class="n">bbclass</span>
<span class="o">==============================================================</span>

<span class="n">export</span> <span class="n">PACKAGE_INSTALL</span> <span class="err">?</span><span class="o">=</span> <span class="s2">&#34;${IMAGE_INSTALL} ${ROOTFS_BOOTSTRAP_INSTALL} ${FEATURE_INSTALL}&#34;</span>  
<span class="o">...</span>  
<span class="n">addtask</span> <span class="n">rootfs</span> <span class="n">before</span> <span class="n">do_build</span></code></pre></div>
<p>Class này phụ thuộc vào biến IMAGE_INSTALL và các biến khác vì thế. Các package cần được build trước.<br />
Ta cũng thấy một task là <em>rootfs</em> chạy trước task build. Vì thế khi mà tất cả các task khác được chạy<br />
xong thì do_rootfs sẽ bắt đầu việc tạo image.</p>

<p>Sau khi check một vài thư mục, do_rootfs sẽ gọi đến hàm tạo cho loại package tương tứng.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">meta</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span><span class="n">image</span><span class="o">.</span><span class="n">bbclass</span><span class="p">,</span> <span class="n">do_rootfs</span><span class="p">()</span>

<span class="n">rootfs_</span><span class="err">$</span><span class="p">{</span><span class="n">IMAGE_PKGTYPE</span><span class="p">}</span><span class="n">_do_rootfs</span></code></pre></div>
<p>ví dụ<br />
trong trường của chúng ta sử dụng ipk, nó sẽ như thế này :<br />
<strong>rootfs_ipk_do_rootfs</strong></p>

<p>Cùng xem 1 chút về hàm tạo <strong>rootfs_ipk_do_rootfs</strong> này<br />
rootfs_ipk_do_rootfs() tạo các thư mục cần thiết cho opkg làm việc, ghi một số file trạng thái và update chings nó<br />
bằng : <em>opk-cl update</em>.</p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/bitbake/" rel="tag">Bitbake</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/distro/" rel="tag">Distro</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/helloworld/" rel="tag">HelloWorld</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "minatu2d" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>