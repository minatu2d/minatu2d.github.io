<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Ví dụ cơ bản với pthread trên Linux - Lazytrick</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick" rel="home">
				<div class="logo__title">Lazytrick</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Posts</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">About</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ví dụ cơ bản với pthread trên Linux</h1>
			
		</header><div class="content post__content clearfix">
			</p>
<p>[code lang=c]<br />
/******************************************************************************<br />
* FILE: hello.c<br />
* DESCRIPTION:<br />
*   Chuong trinh demo thao tac tao thread, tat thread<br />
* AUTHOR: Blaise Barney<br />
* LAST REVISED: 08/09/11<br />
*<br />
* TRANSLATE to Vietnamese by Minatu<br />
* COMPILE CMD : $gcc -o hello hello.c -lpthread<br />
******************************************************************************/<br />
//<br />
#include &lt;pthread.h&gt;<br />
#include &lt;stdio.h&gt;<br />
#include &lt;stdlib.h&gt;<br />
#define NUM_THREADS     5</p>
<p>void *PrintHello(void *threadid)<br />
{<br />
   long tid;<br />
   tid = (long)threadid;<br />
   printf(&quot;Hello World! Thread #%ld o day !!!\n&quot;, tid);<br />
   pthread_exit(NULL);<br />
}</p>
<p>int main(int argc, char *argv[])<br />
{<br />
   pthread_t threads[NUM_THREADS];<br />
   int rc;<br />
   long tId;</p>
<p>   for(tId = 0; tId &lt; NUM_THREADS; tId++){<br />
     printf(&quot; Ham main() : Thread Main : Tao...thread moi: %ld\n&quot;, tId);<br />
     rc = pthread_create(<br />
                        &amp;threads[tId],<br />
                        NULL,<br />
                        PrintHello,<br />
                        (void *)tId);<br />
     if (rc){<br />
       printf(&quot;ERROR; loi khi chay pthread_create(), ma loi: %d\n&quot;, rc);<br />
       exit(-1);<br />
       }<br />
     }</p>
<p>   /* Last thing that main() should do */<br />
   pthread_exit(NULL);<br />
}<br />
[/code]</p>
<p>Kết quả sau khi biên dịch và chạy:</p>
<p>[code lang=shell]<br />
oedev@OEDEV-Ubuntu:code$ gcc -o hello hello.c -lpthread<br />
oedev@OEDEV-Ubuntu:code$ ./hello<br />
 Ham main() : Thread Main : Tao...thread moi: 0<br />
 Ham main() : Thread Main : Tao...thread moi: 1<br />
Hello World! Thread #0 o day !!!<br />
 Ham main() : Thread Main : Tao...thread moi: 2<br />
Hello World! Thread #1 o day !!!<br />
 Ham main() : Thread Main : Tao...thread moi: 3<br />
 Ham main() : Thread Main : Tao...thread moi: 4<br />
Hello World! Thread #2 o day !!!<br />
Hello World! Thread #3 o day !!!<br />
Hello World! Thread #4 o day !!!<br />
[/code]</p>
<p>Như ta thấy, các thread được tạo và chạy hàm <code>PrintHello</code> rồi hiển thị giá trị <code>tId</code><br />
được truyền khi tạo trong nội dung của nó.<br />
Ta chú ý ở đây, thông tin hiện ra màn hình có thể không theo <strong>thứ tự đâu</strong>.<br />
Tức là có thể dù thread 1 được tạo trước thread 2 nhưng chưa chắc chữ <code>Hello World</code><br />
của nó sẽ ra trước thread 2.</p>
<p>Nói kĩ hơn về các hàm sử dụng ở trên:</p>
<p>[code lang=c]<br />
     rc = pthread_create(<br />
                        &amp;threads[tId],<br />
                        NULL,<br />
                        PrintHello,<br />
                        (void *)tId);<br />
[/code]</p>
<p>Trong đó,<br />
- Tham số thứ nhất: <code>&amp;amp;threads[tId]</code> : Chứa các thông tin của thread sau khi được tạo.<br />
Bất cứ thao tác nào liên quan đến thread này đều thông qua biến này.</p>
<ul>
<li>Tham số thứ 2 : <code>NULL</code> : Tức là không set thêm thuộc tính nào cho thread sẽ được tạo,<br />
lấy hết mặc định.</li>
<li>
<p>Tham số thứ 3 : <code>PrintHello</code> : Hàm (hoặc con trỏ hàm) sẽ chạy trong thread sau khi được tạo.<br />
Thông thường hàm này sẽ chạy mãi bằng một vòng lặp vô tận chẳng hạn.</p>
</li>
<li>
<p>Tham số thứ 4 : <code>(void*)tId</code> : Tham số này là một con trỏ thôi, kiểu gì cũng được.<br />
Nó sẽ được truyền như là tham số như thread thực hiện hàm đã truyền ở tham số thứ 3.<br />
Trong trường hợp này hàm <code>PrintHello</code> nhận tham số <code>void *</code> vì thế nên ép kiểu sang<br />
<code>void *</code> cho <code>tId</code>. Và ta cũng thấy, giá trị <code>tId</code> được ép kiểu trở lại trong hàm <code>PrintHello</code></p>
</li>
</ul>
<p>Tiếp theo đến</p>
<p>[code lang=c]<br />
   pthread_exit(NULL);<br />
[/code]</p>
<ul>
<li>Tham số của hàm này ở đây được sử dụng để truyền ra cho một thread khác đang đợi bằng <code>join</code><br />
nó kết thúc, trong trường hợp này không sử dụng nên giá trị nó là NULL.</li>
</ul>
<h2>2. Thêm một chút xử lý cho thread</h2>
<ul>
<li>Giả sử mỗi thread chạy một vòng lặp vô hạn, sẽ in giá trị tăng dần đến các terminal (được bật sẵn)<br />
khác nhau.</li>
<li>Để đơn giản, ta sử dụng 4 terminal.<br />
1 Terminal (gọi là Terminal 0) để cho thread chính hay chính cái xử lý chứa hàm <code>main()</code><br />
3 Terminal (gọi là Terminal 1,2,3) còn lại sẽ sử dụng để 5 thread con được tạo hiển thị giá trị:<br />
Thread 1, 2 sẽ hiển thị Terminal 1<br />
Thread 3, 4 sẽ hiển thị Terminal 2<br />
Thread 5    sẽ hiển thị Terminal 3</li>
</ul>
<li>
<p>Mỗi terminal trong Linux có thể được truy cập qua một đường dẫn file.<br />
Ta có thể lấy đường dẫn của terminal ta đang sử dụng bằng lệnh <code>tty</code><br />
Giả sử 4 terminal của chúng ta có đường dẫn tương ứng là:<br />
<code>/dev/pts/15</code> đến <code>/dev/pts/17</code></p>
</li>
<li>
<p>Ta sẽ sửa lại hàm <code>PrintHello</code> ở trên như sau:</p>
</li>
<p>[code lang=c]<br />
const char* TERMINAL_DEV_FILES[] = {<br />
&quot;/dev/pts/19&quot;,<br />
&quot;/dev/pts/19&quot;,<br />
&quot;/dev/pts/20&quot;,<br />
&quot;/dev/pts/20&quot;,<br />
&quot;/dev/pts/21&quot;,<br />
};</p>
<p>void PrintHello(void *threadid)<br />
{<br />
   FILE *fo = NULL;<br />
   long count = 0;<br />
   long tid;<br />
   tid = (long)threadid;<br />
   fo = fopen(TERMINAL_DEV_FILES[tid], &quot;a&quot;);<br />
   if (fo != NULL)<br />
   {<br />
      count = 0;<br />
      while (1)<br />
      {<br />
          fprintf(fo,&quot;Thread %ld : %ld\n&quot;,tid + 1, ++count) ;<br />
          if (count == 100) break;<br />
          sleep(3);<br />
      }<br />
   }<br />
   fclose(fo);<br />
   printf(&quot;Bye!!!! Thread #%ld o day !!!\n&quot;, tid);<br />
   pthread_exit(NULL);<br />
}<br />
[/code]</p>
<p>Giử sử thread chính sẽ được chạy từ một terminal khác.<br />
Kết quả sẽ như sau:<br />
<a href="https://youtu.be/Gpy6m8B19qc">https://youtu.be/Gpy6m8B19qc</a></p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/pthread/" rel="tag">pthread</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/thread/" rel="tag">thread</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "minatu2d" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>