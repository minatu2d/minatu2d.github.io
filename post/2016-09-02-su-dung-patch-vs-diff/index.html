<!DOCTYPE html>
<html lang="en-us">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Sử dụng Patch và Diff</title>
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/html.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/ruby.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/perl.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.58.3" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">Sử dụng Patch và Diff</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                                <li><a href="/categories/">Category</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:pvta2pn@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/minatu2d/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://facebook.com/pvta2cvp/"><i class="fa fa-facebook"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>Sử dụng Patch và Diff</h2>
        <h5>September 2, 2016</h5>
        
<a href="tags/command"><kbd class="item-tag">Command</kbd></a>


    </div>

    <div align="start" class="content"></p>
<p>Tư tưởng khá đơn giản, thay vì update toàn bộ source bằng cách nén source muốn test và chuyển vào máy thật như mình đang làm, giờ chỉ tải phần thay đổi vào máy rồi đưa phần thay đối đó lên source cũ.</p>
<p>Cũng có 1 cách là lấy tập các file thay đổi rồi ghi đè, nhưng cách đó có vẻ không hiệu quả bằng cách dùng 2 command <strong>Patch</strong> và <strong>Diff</strong></p>
<p><strong>Diff</strong> sẽ tạo ra file chứa các thay đổi của phiên bản cũ so với phiên bản mới, file .patch. (thường được thực hiện trên môi trường phát triển)<br />
<strong>Patch</strong> sẽ đưa các thay đổi được ghi trong file .patch sang source cũ. (thường được thực hiện trên môi trường chạy - tức Runtime)<br />
Chú ý rằng, <strong>patch</strong>, <strong>diff</strong> chỉ thực hiện với các file text thôi.<br />
Các file binary thì phải dùng lệnh khác.</p>
<p>Ta hãy bắt đầu sử dụng với một vài tình huống thực tế dựa trên các thao tác cơ bản là thêm, sửa, xóa.</p>
<p>Giả sử ta có 1 source như sau:</p>
<ol>
<li>Thêm file</li>
<li>Sửa file</li>
<li>Xóa file</li>
<li>Đổi tên file</li>
<li>Thêm thư mục</li>
<li>Xóa thư mục</li>
</ol>
<p>Giả sử ta đã có 1 phiên bản source với 2 phiên bản sau:</p>
<p>[code lang=shell]<br />
greetings-1.0<br />
├── main.c<br />
└── version.h<br />
greetings-1.0-mod<br />
├── greetings.h<br />
├── main.c<br />
└── version.h<br />
[/code]</p>
<h5>1. Thêm file</h5>
<p>Các file <strong><em>main.c</em></strong>, *<strong>version.h</strong> ở cả 2 bản <strong>1.0</strong> và <strong>1.0-mod</strong> giống hệt nhau.<br />
Giờ ta sẽ thực hiện cập nhật các thay đổi từ <strong>1.0-mod</strong> sang cho <strong>1.0</strong>.</p>
<p>Tạo <strong>patch</strong> file sử dụng <a href="http://linux.die.net/man/1/diff">diff</a>.</p>
<p>[code lang=shell]<br />
diff -uprN greetings-1.0 greetings-1.0-mod &gt; patch_1.0-mod.patch<br />
[/code]</p>
<p>Nội dung file patch sẽ như sau:</p>
<p>[code lang=shell]<br />
$ cat patch_1.0-mod.patch<br />
diff -uprN greetings-1.0/greetings.h greetings-1.0-mod/greetings.h<br />
--- greetings-1.0/greetings.h   1970-01-01 09:00:00.000000000 +0900<br />
+++ greetings-1.0-mod/greetings.h   2016-09-12 13:43:09.128523777 +0900<br />
@@ -0,0 +1,5 @@<br />
+#ifndef __GREETINGS_HEADER__<br />
+#define __GREETINGS_HEADER__<br />
+<br />
+void greetings_vi();<br />
+#endif<br />
[/code]</p>
<p>Thực hiện bản patch này trên biên bản <strong>1.0</strong> bằng command <a href="http://linux.die.net/man/1/patch">patch</a> như sau:</p>
<p>[code lang=shell]<br />
$cd greetings-1.0<br />
$patch -u &lt; ../patch_1.0-mod.patch<br />
patching file greetings.h<br />
[/code]</p>
<p>Source của <strong>1.0</strong> đã được patch, kiểm tra với <a href="http://linux.die.net/man/1/tree">tree</a></p>
<p>[code lang=shell]<br />
greetings-1.0<br />
├── greetings.h<br />
├── main.c<br />
└── version.h<br />
greetings-1.0-mod<br />
├── greetings.h<br />
├── main.c<br />
└── version.h<br />
[/code]</p>
<p>Vì một lý do nào đó, ta muốn quay lại phiên bản <strong>1.0</strong> ban đầu, tức là lúc chưa patch. Ta có thể thực hiện như sau:</p>
<p>[code lang=shell]<br />
$cd greetings-1.0<br />
$patch -uR &lt; ../patch_1.0-mod.patch<br />
patching file greetings.h<br />
[/code]</p>
<p><strong>Patch</strong> sẽ rollback toàn bộ nội ung đã thay đổi ở bước trên, nội dung <strong>1.0</strong> sẽ trở lại như đầu, khi chưa có file <strong><em>greetings.h</em></strong>.</p>
<h5>2. Sửa file</h5>
<p>Ta copy phiên bản <strong>1.0</strong> thanh <strong>1.0-mod2</strong> rồi thêm 1 dòng vào <strong>main.c</strong>, để nó trở thành như sau:</p>
<p>[code lang=C]<br />
#include&lt;stdio.h&gt;<br />
#include&quot;version.h&quot;</p>
<p>int main(int argc, char* argv[])<br />
{<br />
    // Add in v1.0-mod2<br />
    printf(&quot;--This is sample source for patch/diff usage demo\n&quot;);</p>
<p>    printf(&quot;--Version--info--\n&quot;);<br />
    printf(&quot;MAJOR    =%d\n&quot;,VERSION_MAJOR);<br />
    printf(&quot;MINOR    =%d\n&quot;,VERSION_MINOR);<br />
    printf(&quot;REVSION  =%d\n&quot;,REVISION_NUMBER);</p>
<p>    return 0;<br />
}<br />
[/code]</p>
<p>Và thay đổi <strong>REVISON_NUMBER</strong> trong <strong><em>vesion.h</em></strong> lên <strong>2</strong>.<br />
Ok, ta có 2 file thay đổi.</p>
<p>Tạo patch:</p>
<p>[code lang=shell]<br />
diff -uprN greetings-1.0 greetings-1.0-mod2 &gt; patch_1.0-mod2.patch<br />
[/code]</p>
<p>Nội dung <strong><em>patch_1.0-mod2.patch</em></strong>:</p>
<p>[code lang=shell]<br />
diff -uprN greetings-1.0/main.c greetings-1.0-mod2/main.c<br />
--- greetings-1.0/main.c    2016-09-12 10:45:17.584502129 +0900<br />
+++ greetings-1.0-mod2/main.c   2016-09-12 14:05:17.883121135 +0900<br />
@@ -3,6 +3,9 @@</p>
<p> int main(int argc, char* argv[])<br />
 {<br />
+   // Add in v1.0-mod2<br />
+   printf(&quot;--This is sample source for patch/diff usage demo\n&quot;);<br />
+<br />
    printf(&quot;--Version--info--\n&quot;);<br />
    printf(&quot;MAJOR    =%d\n&quot;,VERSION_MAJOR);<br />
    printf(&quot;MINOR    =%d\n&quot;,VERSION_MINOR);<br />
diff -uprN greetings-1.0/version.h greetings-1.0-mod2/version.h<br />
--- greetings-1.0/version.h 2016-09-12 11:46:31.463883113 +0900<br />
+++ greetings-1.0-mod2/version.h    2016-09-12 14:09:00.274072101 +0900<br />
@@ -3,5 +3,5 @@<br />
 // Version :<br />
 #define VERSION_MAJOR 1<br />
 #define VERSION_MINOR 0<br />
-#define REVISION_NUMBER 0<br />
+#define REVISION_NUMBER 2<br />
 #endif<br />
[/code]</p>
<p>Apply bản patch này lên <strong>1.0</strong>:</p>
<p>[code lang=shell]<br />
$cd greetings-1.0<br />
$patch -u &lt; ../patch_1.0-mod2.patch<br />
patching file main.c<br />
patching file version.h<br />
[/code]</p>
<p>Như vậy <strong>1.0</strong> sẽ được cập nhật.<br />
Tất nhiên ta có thể sử dụng tham số *<strong>-R</strong> (Reverse) để xóa bỏ toàn bộ thay đổi mà bản patch mod2 đã làm.</p>
<h5>3. Xóa file</h5>
<p>Ta copy <strong>1.0</strong> thành <strong>1.0-mod3</strong>, và xóa file <strong>main.c</strong>:</p>
<p>Làm tương tự các bước như trên ta sẽ có<br />
Nội dung <strong><em>patch_1.0-mod3.patch</em></strong>:</p>
<p>[code lang=shell]<br />
$ cat patch_1.0-mod3.patch<br />
diff -uprN greetings-1.0/main.c greetings-1.0-mod3/main.c<br />
--- greetings-1.0/main.c    2016-09-12 14:13:52.187548541 +0900<br />
+++ greetings-1.0-mod3/main.c   1970-01-01 09:00:00.000000000 +0900<br />
@@ -1,12 +0,0 @@<br />
-#include&lt;stdio.h&gt;<br />
-#include&quot;version.h&quot;<br />
-<br />
-int main(int argc, char* argv[])<br />
-{<br />
-   printf(&quot;--Version--info--\n&quot;);<br />
-   printf(&quot;MAJOR    =%d\n&quot;,VERSION_MAJOR);<br />
-   printf(&quot;MINOR    =%d\n&quot;,VERSION_MINOR);<br />
-   printf(&quot;REVSION  =%d\n&quot;,REVISION_NUMBER);<br />
-<br />
-   return 0;<br />
-}<br />
[/code]</p>
<p>Ta thực hiện bản patch này trên <strong>1.0</strong>, và có kết quả như sau:</p>
<p>[code lang=shell]<br />
greetings-1.0<br />
└── version.h<br />
greetings-1.0-mod3<br />
└── version.h<br />
[/code]</p>
<p>Thử rollback lại rollback lại bản <strong>patch</strong> vừa rồi, ta vẫn có được kết quả như mong muốn:</p>
<p>[code lang=shell]<br />
greetings-1.0<br />
├── main.c<br />
└── version.h<br />
greetings-1.0-mod3<br />
└── version.h<br />
[/code]</p>
<h5>4. Đổi tên file</h5>
<p>Ta copy <strong>1.0</strong> thành <strong>1.0-mod4</strong>, rồi đổi <strong><em>main.c</em></strong> thành <strong><em>main_app.c</em></strong>.<br />
Ta vẫn thực hiện được các bước như ở 2,3,4 và có được kết quả mong muốn.<br />
Xem qua file patch, ta có thể thấy phép đổi tên sẽ tương đương với phép xóa file có tên cũ và thêm file có tên mới với cũng nội dung.</p>
<p>[code lang=shell]<br />
$ cat patch_1.0-mod4.patch<br />
diff -uprN greetings-1.0/main_app.c greetings-1.0-mod4/main_app.c<br />
--- greetings-1.0/main_app.c    1970-01-01 09:00:00.000000000 +0900<br />
+++ greetings-1.0-mod4/main_app.c   2016-09-12 14:23:11.569704749 +0900<br />
@@ -0,0 +1,12 @@<br />
+#include&lt;stdio.h&gt;<br />
+#include&quot;version.h&quot;<br />
+<br />
+int main(int argc, char* argv[])<br />
+{<br />
+   printf(&quot;--Version--info--\n&quot;);<br />
+   printf(&quot;MAJOR    =%d\n&quot;,VERSION_MAJOR);<br />
+   printf(&quot;MINOR    =%d\n&quot;,VERSION_MINOR);<br />
+   printf(&quot;REVSION  =%d\n&quot;,REVISION_NUMBER);<br />
+<br />
+   return 0;<br />
+}<br />
diff -uprN greetings-1.0/main.c greetings-1.0-mod4/main.c<br />
--- greetings-1.0/main.c    2016-09-12 14:20:47.563705673 +0900<br />
+++ greetings-1.0-mod4/main.c   1970-01-01 09:00:00.000000000 +0900<br />
@@ -1,12 +0,0 @@<br />
-#include&lt;stdio.h&gt;<br />
-#include&quot;version.h&quot;<br />
-<br />
-int main(int argc, char* argv[])<br />
-{<br />
-   printf(&quot;--Version--info--\n&quot;);<br />
-   printf(&quot;MAJOR    =%d\n&quot;,VERSION_MAJOR);<br />
-   printf(&quot;MINOR    =%d\n&quot;,VERSION_MINOR);<br />
-   printf(&quot;REVSION  =%d\n&quot;,REVISION_NUMBER);<br />
-<br />
-   return 0;<br />
-}<br />
[/code]</p>
<h5>5. Thêm thư mục</h5>
<p>Ta cũng copy <strong>1.0</strong> thành <strong>1.0-mod5</strong>, và thêm vào thư mục trống <strong><em>lib</em></strong>.<br />
Khi thực hiện <strong>diff</strong>, ta không thấy có sự khác nhau nào được sinh ra.<br />
vì thế không có bản <strong>patch</strong> nào trong trường hợp thêm 1 thư mục rỗng.</p>
<p>Việc thay đổi tham số của câu lệnh diff không tính đến ở đây.</p>
<p>Giờ ta thêm 1 file vào thư mục <strong><em>lib</em></strong> xem sao?<br />
Cấu trúc thư mục mới của <strong>1.0-mod5</strong>:</p>
<p>[code lang=shell]<br />
greetings-1.0-mod5<br />
├── lib<br />
│   └── abc.c<br />
├── main.c<br />
└── version.h<br />
[/code]</p>
<p>Ta tiến hành lại các bước tạo patch và apply patch như đã làm.<br />
Patch file có nội dung như sau:</p>
<p>[code lang=shell]<br />
$ cat patch_1.0-mod5.patch<br />
diff -uprN greetings-1.0/lib/abc.c greetings-1.0-mod5/lib/abc.c<br />
--- greetings-1.0/lib/abc.c 1970-01-01 09:00:00.000000000 +0900<br />
+++ greetings-1.0-mod5/lib/abc.c    2016-09-12 14:35:25.920931214 +0900<br />
@@ -0,0 +1,6 @@<br />
+#include&lt;stdio.h&gt;<br />
+<br />
+void abc_initialize()<br />
+{<br />
+   // Code later<br />
+}<br />
[/code]</p>
<p>Khi thực hiện apply patch file trên <strong>1.0</strong>, lệnh ta vẫn dùng sẽ không tạo ra thư mục mà ta chỉ thấy có file xuất hiện thôi.<br />
Đã thử thay đổi 1 vài tham số, và lệnh dưới đây đã chạy:</p>
<p>[code lang=shell]<br />
$cd greetings-1.0<br />
$ patch -u -p1 &lt; ../patch_1.0-mod5.patch<br />
$ tree .<br />
├── lib<br />
│   └── abc.c<br />
├── main.c<br />
└── version.h<br />
[/code]</p>
<p><strong>p1</strong> : ở đây được hiểu là sẽ bỏ qua 1 lần <strong>/</strong>.</p>
<h5>6. Xóa thư mục</h5>
<p>Giờ ta lấy copy <strong>1.0-mod5</strong> thanh <strong>1.0-mod5r</strong>, rồi xóa bỏ thư mục <strong><em>lib</em></strong>.<br />
Nội dung bản patch như sau:</p>
<p>[code lang=shell]<br />
oedev@OEDEV-Ubuntu:~/geek/patchdiff$ cat patch_1.0-mod5r.patch<br />
diff -uprN greetings-1.0-mod5/lib/abc.c greetings-1.0-mod5r/lib/abc.c<br />
--- greetings-1.0-mod5/lib/abc.c    2016-09-12 14:35:25.920931214 +0900<br />
+++ greetings-1.0-mod5r/lib/abc.c   1970-01-01 09:00:00.000000000 +0900<br />
@@ -1,6 +0,0 @@<br />
-#include<br />
-<br />
-void abc_initialize()<br />
-{<br />
-   // Code later<br />
-}<br />
[/code]</p>
<p>Khi apply patch, thì tương tự như trên ta cần thêm <strong><em>p0</em></strong></p>
<p>[code lang=shell]<br />
$patch -u -p1 &lt;../patch_1.0-mod5r.patch<br />
patching file lib/abc.c<br />
[/code]</p>
</div>

    
    
    
        <h4 class="page-header">Related</h4>
         <div class="item">

    
    
    

    
    

    <h4><a href="/post/2016-09-07-awk-su-dung-co-ban/">AWK - Sử dụng cơ bản</a></h4>
    <h5>September 7, 2016</h5>
    
<a href="tags/command"><kbd class="item-tag">Command</kbd></a>

<a href="tags/linux"><kbd class="item-tag">Linux</kbd></a>



</div>
 
    

    
    
        <h4 class="page-header">Comments</h4>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "username" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</main>

        <footer>
            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

