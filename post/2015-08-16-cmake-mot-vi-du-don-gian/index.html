<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>CMake - Một ví dụ đơn giản - Lazytrick</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/example.com/css/style.css">
	
	<link rel="shortcut icon" href="/example.com/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/example.com" title="Lazytrick" rel="home">
				<div class="logo__title">Lazytrick</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="example.com/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="example.com/post/">Posts</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="example.com/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="example.com/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="example.com/about/">About</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CMake - Một ví dụ đơn giản</h1>
			
		</header><div class="content post__content clearfix">
			

<p>Trong bài tôi đã giới thiệu qua về CMake. Như ta đã biết nó cung cấp tính tăng giúp việc sinh ra Makefile một cách hiệu quả. Nhất là đối với các dự án phức tạp. Nó cũng cung cấp thêm các bộ sinh khác để sinh cấu trúc quản lý source cho các IDE khác nhau như Visual Studio, KDE.<br />
Trong giới hạn, tôi sẽ nói về việc sử dụng CMake để build một simple project trên cả Windows và Linux.</p>

<p>Ta vẫn xoay quanh ví dụ kinh điển là tạo chương trình Hello World, nhưng yêu cầu hiển thị câu đó trên ít nhất 3 ngôn ngữ. ja,en,vi. Chương trình sẽ viết bằng ngôn ngữ C.</p>

<p>(<a href="http://derekmolloy.ie/hello-world-introductions-to-cmake/">Link tham khảo</a>)<br />
Ví dụ được thực hiện trong thư mục <em>/home/oedev/Code/CMake</em></p>

<p>Nội dung chính gồm các phần sau,<br />
1. Chương trình Hello World cho En.<br />
2. Thêm ngôn ngữ Ja, Vi vào chương trình trên.<br />
3. Thêm ngôn ngữ Ja, Vi trong một tình huống khác.</p>

<h2 id="1-chương-trình-hello-world-cho-en">1.Chương trình Hello World cho En</h2>

<p>Ta sẽ có file source như sau:  <code>mainapp.c</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">//  
</span><span class="c1">// Greeting message in En  
</span><span class="c1">//  
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">greeting_en</span><span class="p">()</span>  
<span class="p">{</span>  
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello world n&#34;</span><span class="p">);</span>  
<span class="p">}</span>

<span class="c1">//  
</span><span class="c1">// Main functions  
</span><span class="c1">//  
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>  
<span class="p">{</span>  
  <span class="n">greeting_en</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  </code></pre></div>
<p>File sử dụng cho CMake là 1 file CMakeLists.txt</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">#  
<span class="c1"># Điều kiện về version tối thiểu để đọc được file CMakeList.txt này.</span>  
#  
cmake_minimum_required<span class="o">(</span>VERSION <span class="m">2</span>.8.12<span class="o">)</span>

#  
<span class="c1"># Tên project thường sẽ là tên file chạy</span>  
#  
project <span class="o">(</span>helloworld<span class="o">)</span>

#  
<span class="c1"># Định nghĩa mối liên quan giữa file chạy và file nguồn</span>  
#  
add_executable<span class="o">(</span>hellworld mainapp.c<span class="o">)</span>  </code></pre></div>
<p>Đặt cả 2 file trên vào cùng 1 thư mục:<br />
Nội dung được kiểm tra bằng lệnh <code>tree</code>như sau</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">CMake  
├── CMakeLists.txt  
└── mainapp.c  </code></pre></div>
<p>File <code>CMakeList.txt</code> chính là file định nghĩa source sử dụng ngôn ngữ mà <code>CMake</code> hiểu được.<br />
Đến đây, ta thực hiện công việc chính của <code>CMake</code>. Đó là sinh ra <code>Makefiles</code> cho project đơn giản này. Ta phải chuyển vào bên trong thư mục <code>CMake</code> trước khi chạy lệnh dưới đây:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ cmake .  </code></pre></div>
<p>Dấu <code>.</code> phía sau rất quan trọng, hay có thể thay nó bằng <code>$(PWD)</code> trong trường hợp này.<br />
Tham số thứ 2 là thư mục chưa file <code>CMakeFile.txt</code>
Nội dung chạy xong nên như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">oedev@OECrossDev:~/Code/CMake$ cmake .  
-- The C compiler identification is GNU <span class="m">4</span>.8.2  
-- The CXX compiler identification is GNU <span class="m">4</span>.8.2  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc -- works  
-- Detecting C compiler ABI info  
-- Detecting C compiler ABI info - <span class="k">done</span>  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++ -- works  
-- Detecting CXX compiler ABI info  
-- Detecting CXX compiler ABI info - <span class="k">done</span>  
-- Configuring <span class="k">done</span>  
-- Generating <span class="k">done</span>  
-- Build files have been written to: /home/oedev/Code/CMake  </code></pre></div>
<p>Nội dung thư mục sau khi chạy lệnh trên:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree -L <span class="m">2</span>  
.  
├── CMakeCache.txt  
├── CMakeFiles  
│   ├── <span class="m">2</span>.8.12.2  
│   ├── cmake.check_cache  
│   ├── CMakeDirectoryInformation.cmake  
│   ├── CMakeOutput.log  
│   ├── CMakeTmp  
│   ├── hellworld.dir  
│   ├── Makefile2  
│   ├── Makefile.cmake  
│   ├── progress.marks  
│   └── TargetDirectories.txt  
├── cmake_install.cmake  
├── CMakeLists.txt  
├── mainapp.c  
└── Makefile  </code></pre></div>
<p>Như ta thấy, có rất nhiều file và thư mục được tạo ra khi ta chạy <code>CMake</code>. Nhưng trong giới hạn bài này ta chỉ quan tâm đến <code>Makefile</code> thôi.<br />
Ta cũng thấy rằng chương trình chương được build, hay nói cách khác <code>CMake</code> chỉ làm nhiệm vụ của nó đến đây thôi. Tức là nhiệm vụ của một công cụ sinh <code>Makefiles</code>.</p>

<p>Giờ muốn build project ta vừa tạo lúc đầu (chỉ có 1 file .c), ta sẽ chạy Makefiles thôi.</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ make  
Scanning dependencies of target hellworld  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Building C object CMakeFiles/hellworld.dir/mainapp.c.o  
Linking C executable hellworld  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target hellworld  </code></pre></div>
<p>Kết quả thu được như sau</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ ls  
CMakeCache.txt CMakeFiles cmake_install.cmake CMakeLists.txt hellworld mainapp.c Makefile  </code></pre></div>
<p>Ta đã thây file <em>helloword</em> được sinh ra, đây chính là file chạy:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ ./hellworld  
Hello world  </code></pre></div>
<p>Giờ ta sẽ thêm lời chào bằng ngôn ngữ Ja, Vi vào chương trình trên.</p>

<h2 id="2-thêm-ngôn-ngữ-ja-vi-vào-chương-trình-trên">2.Thêm ngôn ngữ Ja, Vi vào chương trình trên.</h2>

<p>Ta sẽ tổ chức lại source như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree  
.  
├── CMakeLists.txt  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
└── src  
├── greetings_en.c  
├── greetings_ja.c  
├── greetings_vi.c  
└── mainapp.c  </code></pre></div>
<p>Do cấu trúc thư mục đã thay đổi, vị trí các file nguồn cũng thế.<br />
Ta cần thay đổi file <code>CMakeList.txt</code> để phù hợp với thay đổi này.<br />
Nội dung file này sẽ thành như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">#  
<span class="c1"># Điều kiện về version</span>  
#  
cmake_minimum_required<span class="o">(</span>VERSION <span class="m">2</span>.8.12<span class="o">)</span>

#  
<span class="c1"># Tên project</span>  
#  
project <span class="o">(</span>helloworld<span class="o">)</span>

#  
<span class="c1"># Khai bảo thư mục chứa file header (.h)</span>  
#  
include_directories<span class="o">(</span>include<span class="o">)</span>

#  
<span class="c1"># Thêm từ file nguồn bằng lệnh *set*</span>  
#  
set<span class="o">(</span>SOURCES src/mainapp.c src/greetings_en.c src/greetings_ja.c src/greetings_vi.c<span class="o">)</span>

#  
<span class="c1"># Thêm một tập các file bằng một bộ lọc trong thư mục chưa source</span>  
<span class="c1"># Đây là cách nhanh và phổ biến hơn.</span>  
#  
<span class="c1">#file(GLOB SOURCES &amp;quot;src/*.c&amp;quot;)</span>

#  
<span class="c1"># Định nghĩa sự liên quan giữa file chạy và các file nguồn.</span>  
#  
add_executable<span class="o">(</span>hellworld <span class="si">${</span><span class="nv">SOURCES</span><span class="si">}</span><span class="o">)</span>  </code></pre></div>
<p>Ta sẽ chạy <code>cmake</code> để sinh Makefiles và build chương trình với <code>Makefiles</code> xem kết quả thế nào:<br />
Với các sử dụng hàm <code>set</code>:  <code>Chạy cmake</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ cmake .  
-- The C compiler identification is GNU <span class="m">4</span>.8.2  
-- The CXX compiler identification is GNU <span class="m">4</span>.8.2  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc -- works  
-- Detecting C compiler ABI info  
-- Detecting C compiler ABI info - <span class="k">done</span>  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++ -- works  
-- Detecting CXX compiler ABI info  
-- Detecting CXX compiler ABI info - <span class="k">done</span>  
-- Configuring <span class="k">done</span>  
-- Generating <span class="k">done</span>  
-- Build files have been written to: /home/oedev/Code/CMake  </code></pre></div>
<p><em>Chạy Make</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ make  
Scanning dependencies of target hellworld  
<span class="o">[</span> <span class="m">25</span>%<span class="o">]</span> Building C object CMakeFiles/hellworld.dir/src/mainapp.c.o  
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building C object CMakeFiles/hellworld.dir/src/greetings_en.c.o  
<span class="o">[</span> <span class="m">75</span>%<span class="o">]</span> Building C object CMakeFiles/hellworld.dir/src/greetings_ja.c.o  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Building C object CMakeFiles/hellworld.dir/src/greetings_vi.c.o  
Linking C executable hellworld  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target hellworld  </code></pre></div>
<p><em>Kiểm tra thư mục</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree -L <span class="m">2</span>  
.  
├── CMakeCache.txt  
├── CMakeFiles  
│   ├── <span class="m">2</span>.8.12.2  
│   ├── cmake.check_cache  
│   ├── CMakeDirectoryInformation.cmake  
│   ├── CMakeOutput.log  
│   ├── CMakeTmp  
│   ├── hellworld.dir  
│   ├── Makefile2  
│   ├── Makefile.cmake  
│   ├── progress.marks  
│   └── TargetDirectories.txt  
├── cmake_install.cmake  
├── CMakeLists.txt  
├── hellworld  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
├── Makefile  
└── src  
├── greetings_en.c  
├── greetings_ja.c  
├── greetings_vi.c  
└── mainapp.c  </code></pre></div>
<p><em>Kết quả chạy chương trình</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ ./hellworld  
Hello world  
Konichiwa!!!  
Xin chao !!!!  </code></pre></div>
<p>Khi thay <em>set</em> command bằng command file (GLOB) thì cho kết quả gần như giống hệt nhau.</p>

<h3 id="2-1-tạo-thư-mục-để-build-riêng">2.1 Tạo thư mục để build riêng</h3>

<p>À, có một điểm cần nói ở đây, vừa ta có thấy rất nhiều file (ngoài Makefile) được sinh ra trong quá trình cmake chạy.<br />
Nếu để các file đó chung với thư mục các file source, header ta vừa tạo sẽ gây ra rắc rối, khó quản lý.<br />
Ta sẽ tống các file đó vào 1 thư mục, gọi là thư mục <em>build</em>.<br />
Cấu trúc thư mục sẽ thay đổi như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree  
.  
├── build  
├── CMakeLists.txt  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
└── src  
├── greetings_en.c  
├── greetings_ja.c  
├── greetings_vi.c  
└── mainapp.c  </code></pre></div>
<p>Giờ ta sẽ thực hiện toàn bộ quá trình <em>cmake</em> và <em>make</em> bên trong thư mục <em>build</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ cmake ..  
-- The C compiler identification is GNU <span class="m">4</span>.8.2  
-- The CXX compiler identification is GNU <span class="m">4</span>.8.2  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc -- works  
-- Detecting C compiler ABI info  
-- Detecting C compiler ABI info - <span class="k">done</span>  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++ -- works  
-- Detecting CXX compiler ABI info  
-- Detecting CXX compiler ABI info - <span class="k">done</span>  
-- Configuring <span class="k">done</span>  
-- Generating <span class="k">done</span>  
-- Build files have been written to: /home/oedev/Code/CMake/build  </code></pre></div>
<p>Ta sử dụng <em>..</em> thay vì <em>.</em> như ở các câu lệnh trước, vì ta đã chuyển vào thư mục <em>./build</em> nên file <em>CMakeList.txt</em> ở thư mục cha của thư mục này. Ta phải nói cho cmake biết điều đó.<br />
Tiếp tục chạy lệnh <em>make</em>, ta sẽ có nội dung thư mục <em>CMake</em> sẽ như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree -L <span class="m">3</span>  
.  
├── build  
│   ├── CMakeCache.txt  
│   ├── CMakeFiles  
│   │   ├── <span class="m">2</span>.8.12.2  
│   │   ├── cmake.check_cache  
│   │   ├── CMakeDirectoryInformation.cmake  
│   │   ├── CMakeOutput.log  
│   │   ├── CMakeTmp  
│   │   ├── hellworld.dir  
│   │   ├── Makefile2  
│   │   ├── Makefile.cmake  
│   │   ├── progress.marks  
│   │   └── TargetDirectories.txt  
│   ├── cmake_install.cmake  
│   ├── hellworld  
│   └── Makefile  
├── CMakeLists.txt  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
└── src  
├── greetings_en.c  
├── greetings_ja.c  
├── greetings_vi.c  
└── mainapp.c  </code></pre></div>
<p>Như ta thấy, toàn bộ nội dung của quá trình chạy <em>cmake</em> và <em>make</em> được giữ trong thư mục <em>./build</em>, phần đinh nghĩa source code bên ngoài không bị ảnh hưởng gì hết.<br />
Để chạy chương trình, ta phải vào thư mục <em>./build</em><br />
Kết quả vẫn là :</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ ./hellworld  
Hello world  
Konichiwa!!!  
Xin chao !!!!  </code></pre></div>
<h2 id="3-thêm-ngôn-ngữ-spain-es-trong-một-tình-huống-khác">3. Thêm ngôn ngữ Spain(es) trong một tình huống khác</h2>

<p>Tình huống khác ở đây là gì? Tôi muốn nói đến tình huống như sau:<br />
Giả sử ta có một thư viện chứa lời chào cho 3 ngôn ngữ En, Ja, Vi.<br />
Ta cần thêm ngôn ngữ Es để có một chương trình với loài chào của 4 ngôn ngữ En, Ja, Vi, Es.</p>

<p>Trước hết, ta nên hiểu thư viện như thế nào? Trong C/C++ để sử dụng lại được mã nguồn hoặc để bảo vệ mã nguồn. Người ta thường build những mã nguồn muốn sử dụng lại hoặc đưa cho người khác thành các thư viện.<br />
Về mặt file ta thấy được, thư viện sẽ có 2 loại: thư viện tĩnh(.a) và thư viện động(.so).<br />
Trong các file đó chứa source đã được đưa về dang nào đó của các hàm mà ta đã viết trong file .c của source.</p>

<p>Nếu thư viện chỉ có thế thôi thì chưa đủ, ta cần phải biết thư viện đó cung cấp gì cho bên ngoài có thể sử dụng được. Có thể là biến toàn cục, có thể là hàm.<br />
Các hàm và biến này phải đặt đâu đó trong các file header. Không phải luôn luôn do người viết thư viện cung câp nha. Rồi khi build với source mà ta viết, trình biên dịch sẽ biết cách compile hoặc link cho thích hợp.<br />
File header thường được cung cấp kèm theo các file .a(.so). Nếu không có, thì phải có tài liệu mô tả.<br />
Có cả tài liệu và file header là điều lý tưởng nhất.</p>

<p>Giả định rằng, ta có thư viện chưa xử lý hiển thị 3 loài chào En, Ja, Vi. Nhưng ta chỉ có file header mô tả prototype của các hàm mà không thấy được source của nó.</p>

<h3 id="3-1-build-thư-viện-tĩnh">3.1 Build thư viện tĩnh</h3>

<p>Kết quả của đoạn này sẽ là file thư viện _greetings_en_ja<em>vi.a</em> và 3 file header đi kèm.<br />
Sau đó ta có thể xóa 3 file source(.c) đi được.<br />
Về cấu trúc file, do thư viện không chứa hàm <em>main()</em> được, ta phải bỏ file <em>mainapp.c</em> đi.<br />
Nhớ nhé, thư viện thì chỉ cần file header thôi là dùng được rồi.<br />
Thư viện mẫu mực sẽ không cần đến xem code, ta chỉ cần xem mô tả API hoặc file header là có thể dùng được rồi.<br />
Cấu trúc file mới sẽ như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree -L <span class="m">2</span>  
.  
├── CMakeLists.txt  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
└── src  
├── greetings_en.c  
├── greetings_ja.c  
└── greetings_vi.c  </code></pre></div>
<p>Giờ, ta phải sửa lại file <code>CMakeList.txt</code>, nó sẽ thành như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">#  
<span class="c1"># Điều kiện phiên bản nhỏ nhất của CMake</span>  
#  
cmake_minimum_required<span class="o">(</span>VERSION <span class="m">2</span>.8.12<span class="o">)</span>

#  
<span class="c1"># Tên project</span>  
#  
project <span class="o">(</span>multilang_greetings<span class="o">)</span>

#  
<span class="c1"># Thêm thư mục chứa các file header (.h)</span>  
#  
include_directories<span class="o">(</span>include<span class="o">)</span>

#  
<span class="c1"># Thêm một tập các file source</span>  
#  
file<span class="o">(</span>GLOB SOURCES <span class="p">&amp;</span>quot<span class="p">;</span>src/*.c<span class="p">&amp;</span>quot<span class="p">;</span><span class="o">)</span>

#  
<span class="c1"># Thư viện bao gồm những source nào.</span>  
<span class="c1"># Loại thư viện là STATIC (tĩnh)</span>  
<span class="c1"># Tên thư viện có thể khác tên *project*</span>  
#  
add_library<span class="o">(</span>greetings_enjavi STATIC <span class="si">${</span><span class="nv">SOURCES</span><span class="si">}</span><span class="o">)</span>  </code></pre></div>
<p>Chạy tiếp <em>cmake</em> và <em>make</em> trong thư mục <em>build</em>:<br />
Ta sẽ được kết quả như sau:<br />
Chạy <em>Cmake</em>, kết quả gần như không thay đổi so với trước:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ cmake ..  
-- The C compiler identification is GNU <span class="m">4</span>.8.2  
-- The CXX compiler identification is GNU <span class="m">4</span>.8.2  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc  
-- Check <span class="k">for</span> working C compiler: /usr/bin/cc -- works  
-- Detecting C compiler ABI info  
-- Detecting C compiler ABI info - <span class="k">done</span>  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++  
-- Check <span class="k">for</span> working CXX compiler: /usr/bin/c++ -- works  
-- Detecting CXX compiler ABI info  
-- Detecting CXX compiler ABI info - <span class="k">done</span>  
-- Configuring <span class="k">done</span>  
-- Generating <span class="k">done</span>  
-- Build files have been written to: /home/oedev/Code/CMake/buil  </code></pre></div>
<p>Chạy <em>make</em>:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ make  
Scanning dependencies of target greetings_enjavi  
<span class="o">[</span> <span class="m">33</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_vi.c.o  
<span class="o">[</span> <span class="m">66</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_ja.c.o  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_en.c.o  
Linking C static library libgreetings_enjavi.a  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target greetings_enjavi  </code></pre></div>
<p>Ta thấy rằng tên thư viện sinh ra là _libgreetings<em>enjavi.a</em>, như vậy tiền tố <em>lib</em> được thêm vào tên thư viện ta đã khai báo với _add<em>library</em> trong file CMakeList.txt.<br />
Ta có thể kiểm tra xem thư viện này chứa cái gì, bằng câu lệnh <em>ar</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ ar -t libgreetings_enjavi.a  
greetings_vi.c.o  
greetings_ja.c.o  
greetings_en.c.o  </code></pre></div>
<p>Ta sẽ thấy không có file chạy nào được sinh ra trong thư mục build. Đúng như mong muốn, ta cần build thư viện.<br />
Ta cũng kiểm tra kích thước file này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ ls -lh libgreetings_enjavi.a  
-rw-rw-r-- <span class="m">1</span> oedev oedev *4.9K*  8月 <span class="m">17</span> <span class="m">23</span>:13 libgreetings_enjavi.a  </code></pre></div>
<p>Đó là 4.9K (dung lượng NET), còn trên đĩa chắc phải hơn.</p>

<h3 id="3-2-build-thư-viện-động">3.2 Build thư viện động</h3>

<p>Ta đã build thư viện tĩnh, được file .a (một file nén chưa 3 file .o). Kích thước 4.9K(NET)<br />
Giờ ra build thư viện động.<br />
Vậy động với tĩnh khác nhau ở chỗ nào, tại sao phải build cả động làm gì.<br />
Chuyện khá dài, tôi sẽ trình bày ngắn gọn. Thư viện tĩnh, tức là tất cả xử lý của mọi hàm đều nằm trong thư viện đó rồi. Ví dụ, nó gọi hàm <em>printf</em> trong source .c, thì khi tạo thư viện tĩnh, nó ôm toàn bộ xử lý của printf vào trong file .a mà ta vừa tạo.<br />
Còn thư viện động, thì không làm thế, nó lưu lại thông tin báo là, chỗ này gọi hàm printf với các tham số x,y,z gì đó. Khi nào chạy thì hỏi tiếp xem hàm đó ở đâu, xử lý thế nào rồi mới truyền các tham số để xử lý.</p>

<p>Cấu trúc các file source, header không thay đổi gì so với khi build thư viện tĩnh.<br />
Ta cần thay đổi file <em>CMakeList.txt</em> một chút:<br />
Nó sẽ có nội dung như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">#  
<span class="c1"># Điều kiện phiên bản nhỏ nhất của CMake</span>  
#  
cmake_minimum_required<span class="o">(</span>VERSION <span class="m">2</span>.8.12<span class="o">)</span>

#  
<span class="c1"># Tên project</span>  
#  
project <span class="o">(</span>multilang_greetings<span class="o">)</span>

#  
<span class="c1"># Thêm thư mục chứa các file header (.h)</span>  
#  
include_directories<span class="o">(</span>include<span class="o">)</span>

#  
<span class="c1"># Thêm một tập các file source</span>  
#  
file<span class="o">(</span>GLOB SOURCES <span class="p">&amp;</span>quot<span class="p">;</span>src/*.c<span class="p">&amp;</span>quot<span class="p">;</span><span class="o">)</span>

#  
<span class="c1"># Thư viện bao gồm những source nào.</span>  
<span class="c1"># Loại thư viện là SHARED(động, thực ra không sát nghĩa cho lắm)</span>  
<span class="c1"># Tên thư viện có thể khác tên *project*</span>  
#  
add_library<span class="o">(</span>greetings_enjavi SHARED <span class="si">${</span><span class="nv">SOURCES</span><span class="si">}</span><span class="o">)</span>  </code></pre></div>
<p>Kết quả của khi chạy <em>CMake</em> là không thay đổi gì, còn khi chạy <em>make</em>, nó sẽ như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ make  
Scanning dependencies of target greetings_enjavi  
<span class="o">[</span> <span class="m">33</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_vi.c.o  
<span class="o">[</span> <span class="m">66</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_ja.c.o  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Building C object CMakeFiles/greetings_enjavi.dir/src/greetings_en.c.o  
Linking C shared library libgreetings_enjavi.so  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target greetings_enjavi  </code></pre></div>
<p>Thư viện được sinh ra là _libgreetings<em>enjavi.so</em>, cũng bắt đầu với tiền tố <em>lib</em>, nhưng phần mở rộng là .so.<br />
Với thư viện động, ta sẽ kiểm tra nội dung như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ ldd libgreetings_enjavi.so  
linux-vdso.so.1 <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span>  <span class="o">(</span>0x00007fff3e7fc000<span class="o">)</span>  
libc.so.6 <span class="o">=</span><span class="p">&amp;</span>gt<span class="p">;</span> /lib/x86_64-linux-gnu/libc.so.6 <span class="o">(</span>0x00007f6cf04e7000<span class="o">)</span>  
/lib64/ld-linux-x86-64.so.2 <span class="o">(</span>0x00007f6cf0acd000<span class="o">)</span>  </code></pre></div>
<p>Thực ra mình cũng không hiểu kĩ mấy dòng này, tốt nhất không giải thích gì. ;))</p>

<h3 id="3-3-thêm-ngôn-ngữ-es">3.3 Thêm ngôn ngữ Es</h3>

<p>Giờ ta đã có trong tay siêu thư viện với 2 phiên bản, tĩnh và động.<br />
Ta sẽ viết code sử dụng chúng, đồng thời thêm chức năng lời chào bằng tiếng Spain nữa.<br />
+ Với thư viện tĩnh<br />
Gần như rất giống thư viện động, chỉ khác tên file thư viện thôi.<br />
Ta chỉ cần thay _libgreetings<em>enjavi.so</em> trong file <em>CMakeList.txt</em> ở phần dưới bằng _libgreetings<em>enjavi.a</em>, ta đã build ở phần trên thôi.</p>

<ul>
<li><p>Với thư viện động
Cấu trúc thư mục sẽ như sau:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake$ tree -L <span class="m">2</span>  
.  
├── build  
├── CMakeLists.txt  
├── include  
│   ├── greetings_en.h  
│   ├── greetings_es.h  
│   ├── greetings_ja.h  
│   └── greetings_vi.h  
├── lib  
│   └── libgreetings_enjavi.so  
└── src  
├── greetings_es.c  
└── mainapp.c  </code></pre></div></li>
</ul>

<p>Ta cũng cần sửa lại file <em>CMakeList.txt</em> nữa<br />
Nó sẽ thành như thế này:<br />
<em>CMakeList.txt</em></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">#  
<span class="c1"># Ràng buộc về version</span>  
#  
cmake_minimum_required<span class="o">(</span>VERSION <span class="m">2</span>.8.12<span class="o">)</span>

#  
<span class="c1"># Tên project</span>  
#  
project <span class="o">(</span>multilang_greetings<span class="o">)</span>

#  
<span class="c1"># Khai báo nơi chưa thư viện (.so)</span>  
#  
<span class="nb">set</span> <span class="o">(</span>PROJECT_LINK_LIBS libgreetings_enjavi.so<span class="o">)</span>  
link_directories<span class="o">(</span>lib<span class="o">)</span>

#  
<span class="c1"># Nơi chưa các file header(.h)</span>  
#  
include_directories<span class="o">(</span>include<span class="o">)</span>

#  
<span class="c1"># Thêm source .c bằng lệnh set</span>  
#  
<span class="c1">#set(SOURCES src/greetings_es.c)</span>

#  
<span class="c1"># Thêm source .c bằng file GLOB</span>  
#  
file<span class="o">(</span>GLOB SOURCES <span class="p">&amp;</span>quot<span class="p">;</span>src/*.c<span class="p">&amp;</span>quot<span class="p">;</span><span class="o">)</span>

#  
<span class="c1"># File chạy sẽ được tạo như thế nào</span>  
<span class="c1"># Sử dụng thư viện đã khai báo qua PROJECT_LINK_LIBS</span>  
#  
add_executable<span class="o">(</span>helloworld <span class="si">${</span><span class="nv">SOURCES</span><span class="si">}</span><span class="o">)</span>  
target_link_libraries<span class="o">(</span>helloworld <span class="si">${</span><span class="nv">PROJECT_LINK_LIBS</span><span class="si">}</span><span class="o">)</span>  </code></pre></div>
<p>Sau đó, ta cũng chạy <em>CMake</em> và <em>Make</em> để tạo ra file chạy:<br />
Kết quả của việc chạy CMake hầu như vẫn vậy.<br />
Còn kết quả của <em>Make</em> sẽ như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ make  
Scanning dependencies of target helloworld  
<span class="o">[</span> <span class="m">50</span>%<span class="o">]</span> Building C object CMakeFiles/helloworld.dir/src/mainapp.c.o  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Building C object CMakeFiles/helloworld.dir/src/greetings_es.c.o  
Linking C executable helloworld  
<span class="o">[</span><span class="m">100</span>%<span class="o">]</span> Built target helloworld  </code></pre></div>
<p>File chạy là <em>helloworld</em><br />
Kết quả chạy của file này sẽ như thế này:</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">oedev@OECrossDev:~/Code/CMake/build$ ./helloworld  
Hello world  
Konichiwa!!!  
Xin chao !!!!  
Hola!!!  </code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/example.com/tags/cmake/" rel="tag">Cmake</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/example.com/tags/make/" rel="tag">Make</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "minatu2d" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/example.com/js/menu.js"></script>
</body>
</html>