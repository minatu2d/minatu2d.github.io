<!DOCTYPE html>
<html lang="en-us">
    <head>
        

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Cờ Retain và QoS trong message PUBLISH</title>
        
        <style>

    html body {
        font-family: 'Raleway', sans-serif;
        background-color: white;
    }

    :root {
        --accent: red;
        --border-width:  5px ;
    }

</style>


<link rel="stylesheet" href="css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/html.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/ruby.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/shell.min.js"></script>
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/perl.min.js"></script>
    
    <script>hljs.initHighlightingOnLoad();</script>






<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.58.3" />
        

        

        
            <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        

    </head>

    <body>
        

        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand visible-xs" href="#">Cờ Retain và QoS trong message PUBLISH</a>
                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="collapse navbar-collapse">
                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/post/">Posts</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                                <li><a href="/categories/">Category</a></li>
                            
                                <li><a href="/about/">About</a></li>
                            
                        </ul>
                    
                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:pvta2pn@gmail.com"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/minatu2d/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://facebook.com/pvta2cvp/"><i class="fa fa-facebook"></i></a></li>
                            
                        </ul>
                    
                </div>
            </div>
        </nav>


<main>

    <div>
        <h2>Cờ Retain và QoS trong message PUBLISH</h2>
        <h5>February 21, 2016</h5>
        
<a href="tags/mqtt"><kbd class="item-tag">mqtt</kbd></a>


    </div>

    <div align="start" class="content"></p>
<h3>1. Trường QoS (Byte:0, Bit : 2-1, Size:2 bit)</h3>
<p>&nbsp;</p>
<p>Trường này sẽ dùng để miêu tả mong muốn mà Publisher muốn server đảm bảo việc truyền message đến các subscriber. Có 3 mức độ mà subscriber có thể yêu cầu.</p>
<p><em>00b</em> -&gt; cùng lắm là 1 lần. không sử dụng thêm phương thức đảm bảo độ tin cậy nào khác mà tin tưởng vào TCP/IP luôn, cho chiều gửi của PUBLISH.</p>
<p>Như bảng sau:</p>
<table class="flow">
<thead>
<tr>
<th align="center">Publisher (bên cung cấp)</th>
<th align="center">Message và hướng gửi</th>
<th align="center">Server</th>
</tr>
</thead>
<tbody>
<tr>
<td>QoS = 0</td>
<td align="center">PUBLISH<br />
<code>----------&gt;</code></td>
<td><b>Hành động :</b></p>
<p>Đẩy message đến các Subscribers hiện tại.</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><em>01b </em>-&gt; Ít nhất 1 lần, khi Server nhận được message này. Nó thực hiện lần lượt 3 bước " lưu trữ tạm thời message vừa nhận được, gửi message nhận được đến các subscriber hiện tại, cuối cùng xóa message đã lưu. Sau khi thực hiện được bước cuối cùng (xóa message), nó sẽ gửi PUBACK (PUBLISH ACK) về phía Publisher đã gửi gói PUBLISH để thông báo rằng việc chuyển đi đã kết thúc. Nếu phía Publisher sau một thời gian nhất định không nhận được PUBACK nó sẽ coi như bị timeout và gửi lại gói PUBLISH này (với trường DUP được set 1)</p>
<p>Như bảng sau:</p>
<table class="flow">
<thead>
<tr>
<th align="center">Subscriber(bên cung cấp)</th>
<th align="center">Message và hướng gửi</th>
<th align="center">Server</th>
</tr>
</thead>
<tbody>
<tr>
<td>QoS = 1<br />
DUP = 0<br />
Message ID = x<b>Hành động:</b> Lưu tạm thời message sẽ gửi</td>
<td align="center">PUBLISH<br />
<code>----------&gt;</code></td>
<td><b>Hành động:</b></p>
<ul>
<li>Lưu trữ message</li>
<li>Đẩy các message đến các Subscribers</li>
<li>Xóa message</li>
</ul>
</td>
</tr>
<tr>
<td><b>Hành động:</b> Hủy message đã lưu</td>
<td align="center">PUBACK<br />
<code>&lt;----------</code></td>
<td></td>
</tr>
</tbody>
</table>
<p>Phía Server (broker) khi nhận được gói PUBLISH (có trường DUP được set 1), nó sẽ thực hiện các hành động như ở trên. (chính vì thế, có thể xảy ra tình trạng 1 subscriber nhận cùng 1 nội dung đến 2 lần)</p>
<p><em>10b</em> -&gt; Chính xác một lần, có nghĩa là các message được gửi lên từ Publisher qua gói PUBLISH sẽ chuyển đến các Subscriber đúng 1 lần. Ở mức QoS này (mức cao nhất), sẽ không cho phép việc chuyển lặp lại message.</p>
<p>Có 2 kịch bản khi sử dụng level này, phía Server (broker) sẽ tùy chọn implement option nào.</p>
<p>Luồng chuyển message được miêu ta như bảng sau:</p>
<table class="flow">
<thead>
<tr>
<th align="center">Client (bên cung cấp)</th>
<th align="center">Message and hướng gửi</th>
<th align="center">Server</th>
</tr>
</thead>
<tbody>
<tr>
<td>QoS = 2<br />
DUP = 0<br />
Message ID = x<b>Hành động:</b> Lưu message</td>
<td align="center">PUBLISH<br />
<code>----------&gt;</code></td>
<td><b>Hành động:</b> Lưu message</p>
<p align="center"><i>hoặc</i></p>
<p><b>Hành động:</b></p>
<ul>
<li>Lưu message ID</li>
<li>Chuyển message đến các subsriber</li>
</ul>
</td>
</tr>
<tr>
<td></td>
<td align="center">PUBREC<br />
<code>&lt;----------</code></td>
<td>Message ID = x</td>
</tr>
<tr>
<td>Message ID = x</td>
<td align="center">PUBREL<br />
<code>----------&gt;</code></td>
<td><b>Hành động:</b></p>
<ul>
<li>Chuyển message đến các subscriber</li>
<li>Xóa message</li>
</ul>
<p align="center"><i>or</i></p>
<p><b>Action:</b> Xóa message</td>
</tr>
<tr>
<td><b>Hành động:</b> Quên message đã lưu</td>
<td align="center">PUBCOMP<br />
<code>&lt;----------</code></td>
<td>Message ID = x</td>
</tr>
</tbody>
</table>
<h3>2. Trường Retain (Byte:0, Bit:0)</h3>
<p>Chỉ được sử dụng ở PUBLISH. Mục đich để báo với Server biết nên giữ lại message sau khi chuyển đến các Subscriber hiện tại. Message giữ lại sẽ được sử dụng để gửi đến các Subsriber mới subsriber topic mà message này thuộc về.</p>
<p>Trường này sẽ có tác dụng trong trường hợp khi mà Publisher cần thông báo đến các Subsribers mới biết về sự tồn tại của nó. Nó giống như là để lại dấu vết.</p>
<p>Tuy nhiên, đối với các Subsriber đang kết nối đến Server thì trường Retain này sẽ không được Set. Điều này giúp Subscriber phân biệt được đâu là message "mới toanh", đâu mà message được giữ từ trước đó.</p>
<p>Các message phải được lưu lại ngay cả khi khởi động lại server.</p>
<p>Để xóa message đã yêu cầu lưu lại, Publisher chỉ cần gửi một message cùng topic nhưng với trường payload bằng 0.</p>
<h3>3. Ví dụ thực tế với mosquitto</h3>
<p>Ta sẽ thực nghiệm với mosquitto</p>
<ul>
<li>Trường QoS : level = 00b</li>
<li>Trường QoS : level = 01b</li>
<li>Trường QoS : level = 10b</li>
<li>Trường Retain = 0</li>
<li>Trường Retain = 1</li>
</ul>
</div>

    
    
    
        <h4 class="page-header">Related</h4>
         <div class="item">

    
    
    

    
    

    <h4><a href="/post/2016-03-08-truong-remain-length-trong-mqtt-fixed-header/">Trường Remain Length trong MQTT Fixed Header</a></h4>
    <h5>March 8, 2016</h5>
    
<a href="tags/mqtt"><kbd class="item-tag">mqtt</kbd></a>



</div>
  <div class="item">

    
    
    

    
    

    <h4><a href="/post/2015-08-04-giao-thuc-mqtt/">Giao thức MQTT</a></h4>
    <h5>August 4, 2015</h5>
    
<a href="tags/mqtt"><kbd class="item-tag">mqtt</kbd></a>



</div>
 
    

    
    
        <h4 class="page-header">Comments</h4>
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "username" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</main>

        <footer>
            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a>.</p>
        </footer>

        

        
    </body>

</html>

