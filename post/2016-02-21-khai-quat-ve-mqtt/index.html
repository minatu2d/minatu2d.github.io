<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Cờ Retain và QoS trong message PUBLISH - Lazytrick - Limited size memory of mind</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Lazytrick - Limited size memory of mind" rel="home">
				<div class="logo__title">Lazytrick - Limited size memory of mind</div>
				
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">Home</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/">Viết những gì?</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/tags/">Tags</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/categories/">Category</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">Ai viết?</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Cờ Retain và QoS trong message PUBLISH</h1>
			
			


<br>
<i data-feather="calendar">
  Published: <b><time datetime="2016-02-21 00:00:00 &#43;0700">Sun, 21 Feb 2016 15:41:14</time></b> | Last modified:<b><time datetime="2016-02-21 00:00:00 &#43;0700">Sun, 21 Feb 2016 15:41:14</time></b>
  </i> 
		</header><div class="content post__content clearfix">
			

<p>Giao thức MQTT dựa trên mô hình publisher/subscriber (nhà cung cấp/người sử dụng), publisher có dữ liệu trên một lĩnh nào đó (được đại diện bằng các topic), phía subscriber (người mong muốn thông tin) sẽ mong muốn thông tin trên môt lĩnh vực nào đó (cũng được miêu tả bằng topic). Môt anh trung gian ở giữa sẽ nhận từ rất nhiều anh cung cấp trên rất nhiều lĩnh vực, sau đó xem xét, thông tin phù hợp để gửi đến những người sử dụng mà anh trung gian này biết.</p>

<p>Message PUBLISH được gửi từ publisher đến server (hay broker, hay chính là anh trung gian) để cung cấp thông tin.</p>

<p>Bài này nói về 2 trường của message PUBLISH, đó là QoS và Retain. Và 2 trường này tuy nằm ở phần <strong>header cố định</strong> (có trên mọi message). Về trường QoS chỉ được sử dụng ở 3 Message, trong đó PUBLISH (dùng cả 3 level 0, 1, 2), SUBSCRIBE và UNSUBSCRIBE (chỉ dùng level 1). Bài này chỉ nói về message PUBLISH thôi.</p>

<ol>
<li>Trường QoS</li>
<li>Trường Retain</li>
<li>Ví dụ thực tế với mosquitto</li>
</ol>

<h3 id="1-trường-qos-byte-0-bit-2-1-size-2-bit">1. Trường QoS (Byte:0, Bit : 2-1, Size:2 bit)</h3>

<p>Trường này sẽ dùng để miêu tả mong muốn mà Publisher muốn server đảm bảo việc truyền message đến các subscriber. Có 3 mức độ mà subscriber có thể yêu cầu.</p>

<p><em>00b</em> -&gt; cùng lắm là 1 lần. không sử dụng thêm phương thức đảm bảo độ tin cậy nào khác mà tin tưởng vào TCP/IP luôn, cho chiều gửi của PUBLISH.</p>

<p>Như bảng sau:</p>

<p>Publisher (bên cung cấp)</p>

<p>Message và hướng gửi</p>

<p>Server</p>

<p>QoS = 0</p>

<p>PUBLISH<br />
<code>----------&gt;</code></p>

<p><strong>Hành động :</strong></p>

<p>Đẩy message đến các Subscribers hiện tại.</p>

<p><em>01b</em> -&gt; Ít nhất 1 lần, khi Server nhận được message này. Nó thực hiện lần lượt 3 bước &ldquo; lưu trữ tạm thời message vừa nhận được, gửi message nhận được đến các subscriber hiện tại, cuối cùng xóa message đã lưu. Sau khi thực hiện được bước cuối cùng (xóa message), nó sẽ gửi PUBACK (PUBLISH ACK) về phía Publisher đã gửi gói PUBLISH để thông báo rằng việc chuyển đi đã kết thúc. Nếu phía Publisher sau một thời gian nhất định không nhận được PUBACK nó sẽ coi như bị timeout và gửi lại gói PUBLISH này (với trường DUP được set 1)</p>

<p>Như bảng sau:</p>

<p>Subscriber(bên cung cấp)</p>

<p>Message và hướng gửi</p>

<p>Server</p>

<p>QoS = 1<br />
DUP = 0<br />
Message ID = x<strong>Hành động:</strong> Lưu tạm thời message sẽ gửi</p>

<p>PUBLISH<br />
<code>----------&gt;</code></p>

<p><strong>Hành động:</strong></p>

<ul>
<li>Lưu trữ message</li>
<li>Đẩy các message đến các Subscribers</li>
<li>Xóa message</li>
</ul>

<p><strong>Hành động:</strong> Hủy message đã lưu</p>

<p>PUBACK<br />
<code>&lt;----------</code></p>

<p>Phía Server (broker) khi nhận được gói PUBLISH (có trường DUP được set 1), nó sẽ thực hiện các hành động như ở trên. (chính vì thế, có thể xảy ra tình trạng 1 subscriber nhận cùng 1 nội dung đến 2 lần)</p>

<p><em>10b</em> -&gt; Chính xác một lần, có nghĩa là các message được gửi lên từ Publisher qua gói PUBLISH sẽ chuyển đến các Subscriber đúng 1 lần. Ở mức QoS này (mức cao nhất), sẽ không cho phép việc chuyển lặp lại message.</p>

<p>Có 2 kịch bản khi sử dụng level này, phía Server (broker) sẽ tùy chọn implement option nào.</p>

<p>Luồng chuyển message được miêu ta như bảng sau:</p>

<p>Client (bên cung cấp)</p>

<p>Message and hướng gửi</p>

<p>Server</p>

<p>QoS = 2<br />
DUP = 0<br />
Message ID = x<strong>Hành động:</strong> Lưu message</p>

<p>PUBLISH<br />
<code>----------&gt;</code></p>

<p><strong>Hành động:</strong> Lưu message</p>

<p><em>hoặc</em></p>

<p><strong>Hành động:</strong></p>

<ul>
<li>Lưu message ID</li>
<li>Chuyển message đến các subsriber</li>
</ul>

<p>PUBREC<br />
<code>&lt;----------</code></p>

<p>Message ID = x</p>

<p>Message ID = x</p>

<p>PUBREL<br />
<code>----------&gt;</code></p>

<p><strong>Hành động:</strong></p>

<ul>
<li>Chuyển message đến các subscriber</li>
<li>Xóa message</li>
</ul>

<p><em>or</em></p>

<p><strong>Action:</strong> Xóa message</p>

<p><strong>Hành động:</strong> Quên message đã lưu</p>

<p>PUBCOMP<br />
<code>&lt;----------</code></p>

<p>Message ID = x</p>

<h3 id="2-trường-retain-byte-0-bit-0">2. Trường Retain (Byte:0, Bit:0)</h3>

<p>Chỉ được sử dụng ở PUBLISH. Mục đich để báo với Server biết nên giữ lại message sau khi chuyển đến các Subscriber hiện tại. Message giữ lại sẽ được sử dụng để gửi đến các Subsriber mới subsriber topic mà message này thuộc về.</p>

<p>Trường này sẽ có tác dụng trong trường hợp khi mà Publisher cần thông báo đến các Subsribers mới biết về sự tồn tại của nó. Nó giống như là để lại dấu vết.</p>

<p>Tuy nhiên, đối với các Subsriber đang kết nối đến Server thì trường Retain này sẽ không được Set. Điều này giúp Subscriber phân biệt được đâu là message &ldquo;mới toanh&rdquo;, đâu mà message được giữ từ trước đó.</p>

<p>Các message phải được lưu lại ngay cả khi khởi động lại server.</p>

<p>Để xóa message đã yêu cầu lưu lại, Publisher chỉ cần gửi một message cùng topic nhưng với trường payload bằng 0.</p>

<h3 id="3-ví-dụ-thực-tế-với-mosquitto">3. Ví dụ thực tế với mosquitto</h3>

<p>Ta sẽ thực nghiệm với mosquitto</p>

<ul>
<li>Trường QoS : level = 00b</li>
<li>Trường QoS : level = 01b</li>
<li>Trường QoS : level = 10b</li>
<li>Trường Retain = 0</li>
<li>Trường Retain = 1</li>
</ul>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/mqtt/" rel="tag">mqtt</a></li>
	</ul>
</div>
		</footer>
	</article>
</main>



<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-blog-lazytrick-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 Lazytrick - Limited size memory of mind.
			<span class="footer__copyright-credits">Convert nội dung Markdown sang HTML bằng <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and sử dụng theme <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a>.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>